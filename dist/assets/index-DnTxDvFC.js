(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const b of r.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&t(b)}).observe(document,{childList:!0,subtree:!0});function a(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(e){if(e.ep)return;e.ep=!0;const r=a(e);fetch(e.href,r)}})();var F=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function tt(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}function et(u){if(Object.prototype.hasOwnProperty.call(u,"__esModule"))return u;var l=u.default;if(typeof l=="function"){var a=function t(){var e=!1;try{e=this instanceof t}catch{}return e?Reflect.construct(l,arguments,this.constructor):l.apply(this,arguments)};a.prototype=l.prototype}else a={};return Object.defineProperty(a,"__esModule",{value:!0}),Object.keys(u).forEach(function(t){var e=Object.getOwnPropertyDescriptor(u,t);Object.defineProperty(a,t,e.get?e:{enumerable:!0,get:function(){return u[t]}})}),a}var z={exports:{}};function ot(u){throw new Error('Could not dynamically require "'+u+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var q={exports:{}};const st={},nt=Object.freeze(Object.defineProperty({__proto__:null,default:st},Symbol.toStringTag,{value:"Module"})),it=et(nt);var rt=q.exports,V;function at(){return V||(V=1,(function(u,l){(function(a,t){u.exports=t()})(rt,function(){var a=a||(function(t,e){var r;if(typeof window<"u"&&window.crypto&&(r=window.crypto),typeof self<"u"&&self.crypto&&(r=self.crypto),typeof globalThis<"u"&&globalThis.crypto&&(r=globalThis.crypto),!r&&typeof window<"u"&&window.msCrypto&&(r=window.msCrypto),!r&&typeof F<"u"&&F.crypto&&(r=F.crypto),!r&&typeof ot=="function")try{r=it}catch{}var b=function(){if(r){if(typeof r.getRandomValues=="function")try{return r.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof r.randomBytes=="function")try{return r.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},k=Object.create||(function(){function o(){}return function(c){var f;return o.prototype=c,f=new o,o.prototype=null,f}})(),y={},s=y.lib={},S=s.Base=(function(){return{extend:function(o){var c=k(this);return o&&c.mixIn(o),(!c.hasOwnProperty("init")||this.init===c.init)&&(c.init=function(){c.$super.init.apply(this,arguments)}),c.init.prototype=c,c.$super=this,c},create:function(){var o=this.extend();return o.init.apply(o,arguments),o},init:function(){},mixIn:function(o){for(var c in o)o.hasOwnProperty(c)&&(this[c]=o[c]);o.hasOwnProperty("toString")&&(this.toString=o.toString)},clone:function(){return this.init.prototype.extend(this)}}})(),g=s.WordArray=S.extend({init:function(o,c){o=this.words=o||[],c!=e?this.sigBytes=c:this.sigBytes=o.length*4},toString:function(o){return(o||D).stringify(this)},concat:function(o){var c=this.words,f=o.words,$=this.sigBytes,T=o.sigBytes;if(this.clamp(),$%4)for(var I=0;I<T;I++){var R=f[I>>>2]>>>24-I%4*8&255;c[$+I>>>2]|=R<<24-($+I)%4*8}else for(var L=0;L<T;L+=4)c[$+L>>>2]=f[L>>>2];return this.sigBytes+=T,this},clamp:function(){var o=this.words,c=this.sigBytes;o[c>>>2]&=4294967295<<32-c%4*8,o.length=t.ceil(c/4)},clone:function(){var o=S.clone.call(this);return o.words=this.words.slice(0),o},random:function(o){for(var c=[],f=0;f<o;f+=4)c.push(b());return new g.init(c,o)}}),x=y.enc={},D=x.Hex={stringify:function(o){for(var c=o.words,f=o.sigBytes,$=[],T=0;T<f;T++){var I=c[T>>>2]>>>24-T%4*8&255;$.push((I>>>4).toString(16)),$.push((I&15).toString(16))}return $.join("")},parse:function(o){for(var c=o.length,f=[],$=0;$<c;$+=2)f[$>>>3]|=parseInt(o.substr($,2),16)<<24-$%8*4;return new g.init(f,c/2)}},C=x.Latin1={stringify:function(o){for(var c=o.words,f=o.sigBytes,$=[],T=0;T<f;T++){var I=c[T>>>2]>>>24-T%4*8&255;$.push(String.fromCharCode(I))}return $.join("")},parse:function(o){for(var c=o.length,f=[],$=0;$<c;$++)f[$>>>2]|=(o.charCodeAt($)&255)<<24-$%4*8;return new g.init(f,c)}},v=x.Utf8={stringify:function(o){try{return decodeURIComponent(escape(C.stringify(o)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(o){return C.parse(unescape(encodeURIComponent(o)))}},m=s.BufferedBlockAlgorithm=S.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(o){typeof o=="string"&&(o=v.parse(o)),this._data.concat(o),this._nDataBytes+=o.sigBytes},_process:function(o){var c,f=this._data,$=f.words,T=f.sigBytes,I=this.blockSize,R=I*4,L=T/R;o?L=t.ceil(L):L=t.max((L|0)-this._minBufferSize,0);var P=L*I,H=t.min(P*4,T);if(P){for(var w=0;w<P;w+=I)this._doProcessBlock($,w);c=$.splice(0,P),f.sigBytes-=H}return new g.init(c,H)},clone:function(){var o=S.clone.call(this);return o._data=this._data.clone(),o},_minBufferSize:0});s.Hasher=m.extend({cfg:S.extend(),init:function(o){this.cfg=this.cfg.extend(o),this.reset()},reset:function(){m.reset.call(this),this._doReset()},update:function(o){return this._append(o),this._process(),this},finalize:function(o){o&&this._append(o);var c=this._doFinalize();return c},blockSize:16,_createHelper:function(o){return function(c,f){return new o.init(f).finalize(c)}},_createHmacHelper:function(o){return function(c,f){return new E.HMAC.init(o,f).finalize(c)}}});var E=y.algo={};return y})(Math);return a})})(q)),q.exports}var lt=z.exports,K;function ct(){return K||(K=1,(function(u,l){(function(a,t){u.exports=t(at())})(lt,function(a){return(function(t){var e=a,r=e.lib,b=r.WordArray,k=r.Hasher,y=e.algo,s=[];(function(){for(var v=0;v<64;v++)s[v]=t.abs(t.sin(v+1))*4294967296|0})();var S=y.MD5=k.extend({_doReset:function(){this._hash=new b.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(v,m){for(var E=0;E<16;E++){var o=m+E,c=v[o];v[o]=(c<<8|c>>>24)&16711935|(c<<24|c>>>8)&4278255360}var f=this._hash.words,$=v[m+0],T=v[m+1],I=v[m+2],R=v[m+3],L=v[m+4],P=v[m+5],H=v[m+6],w=v[m+7],i=v[m+8],B=v[m+9],A=v[m+10],j=v[m+11],M=v[m+12],U=v[m+13],_=v[m+14],W=v[m+15],n=f[0],p=f[1],d=f[2],h=f[3];n=g(n,p,d,h,$,7,s[0]),h=g(h,n,p,d,T,12,s[1]),d=g(d,h,n,p,I,17,s[2]),p=g(p,d,h,n,R,22,s[3]),n=g(n,p,d,h,L,7,s[4]),h=g(h,n,p,d,P,12,s[5]),d=g(d,h,n,p,H,17,s[6]),p=g(p,d,h,n,w,22,s[7]),n=g(n,p,d,h,i,7,s[8]),h=g(h,n,p,d,B,12,s[9]),d=g(d,h,n,p,A,17,s[10]),p=g(p,d,h,n,j,22,s[11]),n=g(n,p,d,h,M,7,s[12]),h=g(h,n,p,d,U,12,s[13]),d=g(d,h,n,p,_,17,s[14]),p=g(p,d,h,n,W,22,s[15]),n=x(n,p,d,h,T,5,s[16]),h=x(h,n,p,d,H,9,s[17]),d=x(d,h,n,p,j,14,s[18]),p=x(p,d,h,n,$,20,s[19]),n=x(n,p,d,h,P,5,s[20]),h=x(h,n,p,d,A,9,s[21]),d=x(d,h,n,p,W,14,s[22]),p=x(p,d,h,n,L,20,s[23]),n=x(n,p,d,h,B,5,s[24]),h=x(h,n,p,d,_,9,s[25]),d=x(d,h,n,p,R,14,s[26]),p=x(p,d,h,n,i,20,s[27]),n=x(n,p,d,h,U,5,s[28]),h=x(h,n,p,d,I,9,s[29]),d=x(d,h,n,p,w,14,s[30]),p=x(p,d,h,n,M,20,s[31]),n=D(n,p,d,h,P,4,s[32]),h=D(h,n,p,d,i,11,s[33]),d=D(d,h,n,p,j,16,s[34]),p=D(p,d,h,n,_,23,s[35]),n=D(n,p,d,h,T,4,s[36]),h=D(h,n,p,d,L,11,s[37]),d=D(d,h,n,p,w,16,s[38]),p=D(p,d,h,n,A,23,s[39]),n=D(n,p,d,h,U,4,s[40]),h=D(h,n,p,d,$,11,s[41]),d=D(d,h,n,p,R,16,s[42]),p=D(p,d,h,n,H,23,s[43]),n=D(n,p,d,h,B,4,s[44]),h=D(h,n,p,d,M,11,s[45]),d=D(d,h,n,p,W,16,s[46]),p=D(p,d,h,n,I,23,s[47]),n=C(n,p,d,h,$,6,s[48]),h=C(h,n,p,d,w,10,s[49]),d=C(d,h,n,p,_,15,s[50]),p=C(p,d,h,n,P,21,s[51]),n=C(n,p,d,h,M,6,s[52]),h=C(h,n,p,d,R,10,s[53]),d=C(d,h,n,p,A,15,s[54]),p=C(p,d,h,n,T,21,s[55]),n=C(n,p,d,h,i,6,s[56]),h=C(h,n,p,d,W,10,s[57]),d=C(d,h,n,p,H,15,s[58]),p=C(p,d,h,n,U,21,s[59]),n=C(n,p,d,h,L,6,s[60]),h=C(h,n,p,d,j,10,s[61]),d=C(d,h,n,p,I,15,s[62]),p=C(p,d,h,n,B,21,s[63]),f[0]=f[0]+n|0,f[1]=f[1]+p|0,f[2]=f[2]+d|0,f[3]=f[3]+h|0},_doFinalize:function(){var v=this._data,m=v.words,E=this._nDataBytes*8,o=v.sigBytes*8;m[o>>>5]|=128<<24-o%32;var c=t.floor(E/4294967296),f=E;m[(o+64>>>9<<4)+15]=(c<<8|c>>>24)&16711935|(c<<24|c>>>8)&4278255360,m[(o+64>>>9<<4)+14]=(f<<8|f>>>24)&16711935|(f<<24|f>>>8)&4278255360,v.sigBytes=(m.length+1)*4,this._process();for(var $=this._hash,T=$.words,I=0;I<4;I++){var R=T[I];T[I]=(R<<8|R>>>24)&16711935|(R<<24|R>>>8)&4278255360}return $},clone:function(){var v=k.clone.call(this);return v._hash=this._hash.clone(),v}});function g(v,m,E,o,c,f,$){var T=v+(m&E|~m&o)+c+$;return(T<<f|T>>>32-f)+m}function x(v,m,E,o,c,f,$){var T=v+(m&o|E&~o)+c+$;return(T<<f|T>>>32-f)+m}function D(v,m,E,o,c,f,$){var T=v+(m^E^o)+c+$;return(T<<f|T>>>32-f)+m}function C(v,m,E,o,c,f,$){var T=v+(E^(m|~o))+c+$;return(T<<f|T>>>32-f)+m}e.MD5=k._createHelper(S),e.HmacMD5=k._createHmacHelper(S)})(Math),a.MD5})})(z)),z.exports}var dt=ct();const ut=tt(dt);function pt(u,l){let a;return function(...e){const r=()=>{clearTimeout(a),u(...e)};clearTimeout(a),a=setTimeout(r,l)}}function ft(u,l=80){if(!u||!u.includes("commons.wikimedia.org"))return u;try{let a;u.includes("/wiki/File:")?a=u.split("/wiki/File:")[1]:(u.includes("/wikipedia/commons/"),a=u.split("/").pop()),a=decodeURIComponent(a),a=a.replace(/ /g,"_");const t=ut(a).toString(),e=t.charAt(0),r=t.substring(0,2);let b=`https://upload.wikimedia.org/wikipedia/commons/thumb/${e}/${r}/${encodeURIComponent(a)}/${l}px-${encodeURIComponent(a)}`;return b.endsWith(".tif")&&(b=b+".jpg"),b.endsWith(".svg")&&(b=b+".png"),b}catch(a){return console.error("Error converting to thumbnail:",a),u}}function Z(u){if(!u)return"";const l=u.split(/[,\s]+/).filter(a=>a.length>0);return l.length>=2?(l[1][0]+l[0][0]).toUpperCase():l[0][0].toUpperCase()}function G(u,l){const a=Array(l.length+1).fill(null).map(()=>Array(u.length+1).fill(null));for(let t=0;t<=u.length;t+=1)a[0][t]=t;for(let t=0;t<=l.length;t+=1)a[t][0]=t;for(let t=1;t<=l.length;t+=1)for(let e=1;e<=u.length;e+=1){const r=u[e-1]===l[t-1]?0:1;a[t][e]=Math.min(a[t][e-1]+1,a[t-1][e]+1,a[t-1][e-1]+r)}return a[l.length][u.length]}function J(){const u=document.getElementById("search-results");if(u)return u;const l=document.getElementById("search");if(!l)return console.error("Search input not found"),null;const a=l.closest(".field");if(!a)return console.error("Search container not found"),null;const t=document.createElement("div");return t.id="search-results",t.className="columns mt-4",a.parentNode.insertBefore(t,a.nextSibling),t}async function ht(u){if(!u.hits||u.hits.length===0)return'<p class="has-text-grey">No contributors found</p>';const l=[...u.hits].sort((t,e)=>{const r=t.contributions||0;return(e.contributions||0)-r}),a=await Promise.all(l.map(async t=>{let e=t.suggestLabel;if(t.token&&t.token.match(/^n\d+$/))try{const r=await fetch(`https://id.loc.gov/authorities/names/${t.token}.json`);if(r.ok){const k=(await r.json()).find(y=>y["@id"]===`http://id.loc.gov/authorities/names/${t.token}`&&y["@type"]&&(Array.isArray(y["@type"])?y["@type"].includes("http://www.loc.gov/mads/rdf/v1#Authority"):y["@type"]==="http://www.loc.gov/mads/rdf/v1#Authority"));if(k&&k["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"]){const y=k["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"];y&&y.length>0&&y[0]["@value"]&&(e=y[0]["@value"],console.log(`Found name for ${t.token}: ${e}`))}else console.log(`No authoritativeLabel found for ${t.token}`)}}catch(r){console.error(`Error fetching name for ${t.token}:`,r)}return{...t,displayName:e}}));return setTimeout(()=>gt(a),100),a.map(t=>{const e=Z(t.displayName);return`
      <div class="box p-2 mb-2 contributor-box" data-token="${t.token}" data-label="${t.displayName}" style="display: flex; align-items: stretch; min-height: 100px;">
        <div class="contributor-image mr-3" data-lccn="${t.token}">
          <div class="initials-circle" style="width: 80px; height: 100%; min-height: 96px; border-radius: 12px; background: linear-gradient(135deg, #85c1f5 0%, #276dcc 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.5rem;">
            ${e}
          </div>
        </div>
        <div style="flex: 1; padding: 0.5rem 0;">
          <p class="has-text-weight-semibold">${t.displayName}</p>
          ${t.contributions?`<p class="is-size-7 has-text-primary has-text-weight-semibold">${t.contributions} contributions</p>`:""}
          ${t.more?.birthdates&&t.more.birthdates[0]&&t.more.birthdates[0]!=="undefined"?`<p class="is-size-7 has-text-grey">Born: ${t.more.birthdates[0]}</p>`:""}
          ${t.more?.occupations&&t.more.occupations.length>0&&t.more.occupations[0]!=="undefined"?`<p class="is-size-7 has-text-grey">${t.more.occupations.filter(r=>r&&r!=="undefined").join(", ")}</p>`:""}
          <div class="wikidata-info" data-lccn="${t.token}"></div>
        </div>
      </div>
    `}).join("")}async function gt(u){const l=u.map(e=>e.token).filter(e=>e&&e.startsWith("n"));if(l.length===0)return;const a=`
    SELECT ?item ?itemLabel ?lccn ?image ?birthDate ?deathDate ?description WHERE {
      VALUES ?lccn { ${l.map(e=>`"${e}"`).join(" ")} }
      ?item wdt:P244 ?lccn .
      OPTIONAL { ?item wdt:P18 ?image }
      OPTIONAL { ?item wdt:P569 ?birthDate }
      OPTIONAL { ?item wdt:P570 ?deathDate }
      SERVICE wikibase:label {
        bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en" .
        ?item schema:description ?description .
        ?item rdfs:label ?itemLabel .
      }
    }
  `,t=`https://query.wikidata.org/sparql?query=${encodeURIComponent(a)}&format=json`;try{const e=await fetch(t,{headers:{Accept:"application/sparql-results+json"}});if(!e.ok){console.error("Wikidata query failed:",e.status);return}const r=await e.json();console.log("Wikidata results:",r),r.results&&r.results.bindings&&r.results.bindings.forEach(b=>{const k=b.lccn?.value,y=b.description?.value,s=b.item?.value,S=b.image?.value;if(S&&k){const x=document.querySelector(`.contributor-box[data-token="${k}"] .contributor-image`);if(x){const D=ft(S,80),C=document.querySelector(`.contributor-box[data-token="${k}"]`),v=C?C.dataset.label:"";x.innerHTML=`
              <img src="${D}" alt="Author photo" style="width: 80px; height: 100%; min-height: 96px; border-radius: 12px; object-fit: cover; opacity: 0;" onload="this.classList.add('loaded');" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
              <div class="initials-circle" style="width: 80px; height: 100%; min-height: 96px; border-radius: 12px; background: linear-gradient(135deg, #85c1f5 0%, #276dcc 100%); display: none; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.5rem;">
                ${Z(v)}
              </div>
            `}}const g=document.querySelector(`.contributor-box[data-token="${k}"] .wikidata-info`);g&&y&&y!=="undefined"&&(g.innerHTML=`
            <p class="is-size-7 has-text-dark mt-2">
              <strong>Wikidata:</strong> ${y}
            </p>
          `),console.log(`LCCN: ${k}, Description: ${y}, Image: ${S}, Wikidata: ${s}`)})}catch(e){console.error("Error fetching Wikidata:",e)}}function mt(u,l){if(!u.hits||u.hits.length===0)return'<p class="has-text-grey">No titles found</p>';let a=u.hits.filter(e=>!window.excludedUris||!window.excludedUris.has(e.uri));if(a.length===0)return'<p class="has-text-grey">No titles found</p>';const t=a.map(e=>{const r=e.more?.contributors&&e.more.contributors[0],b=r&&e.aLabel&&e.aLabel.includes(r);let k=e.aLabel||e.suggestLabel||"";e.more?.contributors&&e.more.contributors.forEach(g=>{k=k.replace(g,"").replace(/^\.\s*/,"").trim()});let y=l?G(l.toLowerCase(),k.toLowerCase()):999999;b&&r&&l&&(r.toLowerCase().includes(l.toLowerCase())?y=Math.max(0,y-25):y=Math.max(0,y-8));const s=e.more?.languages&&e.more.languages.some(g=>g==="English"||g==="mlang:eng"||g.toLowerCase().includes("eng")),S=e.token?parseInt(e.token):999999999;return{...e,distance:y,originalDistance:l?G(l.toLowerCase(),k.toLowerCase()):999999,labelWithoutContributors:k,hasContributorInLabel:b,isEnglish:s,tokenNum:S}});return t.sort((e,r)=>e.distance!==r.distance?e.distance-r.distance:e.hasContributorInLabel!==r.hasContributorInLabel?e.hasContributorInLabel?-1:1:e.isEnglish!==r.isEnglish?r.isEnglish?1:-1:e.tokenNum-r.tokenNum),t.map(e=>`
    <div class="box p-3 mb-2 title-result" data-uri="${e.uri}" style="cursor: pointer;">
      <p class="has-text-weight-semibold">${e.suggestLabel}</p>
      ${e.vLabel&&e.vLabel!==e.aLabel?`<p class="is-size-6 has-text-dark">${e.vLabel}</p>`:""}
      ${e.more?.contributors&&e.more.contributors.length>1?`<p class="is-size-7 has-text-grey">Contributors: ${e.more.contributors.slice(1).join(", ")}</p>`:""}
      ${e.more?.languages?`<p class="is-size-7 has-text-grey">Language: ${e.more.languages.join(", ")}</p>`:""}
    </div>
  `).join("")}let O=null,N={type:null,data:null};window.performSearches=async function(l){if(N={type:"search",data:{query:l}},O&&(O.abort(),O=null),!l||l.length<2){const b=document.getElementById("search-results");b&&(b.innerHTML="");return}O=new AbortController;const a=O.signal,t=J();if(!t){console.error("Could not create results container");return}t.innerHTML='<div class="column"><p>Searching...</p></div>';const e=`https://id.loc.gov/authorities/names/suggest2/?q=${encodeURIComponent(l)}*&searchtype=keyword&rdftype=PersonalName&usage=true&count=20`,r=`https://id.loc.gov/resources/works/suggest2/?q=${encodeURIComponent(l)}&searchtype=keyword&rdftype=Monograph&rdftype=Text&count=100`;try{const[b,k]=await Promise.all([fetch(e,{signal:a}),fetch(r,{signal:a})]),[y,s]=await Promise.all([b.json(),k.json()]),S=await ht(y);t.innerHTML=`
      <div class="column is-4">
        <h4 class="title is-5 mb-3">Contributors - Click to Load</h4>
        <div class="contributor-results">
          ${S}
        </div>
      </div>
      <div class="column is-8">
        <h4 class="title is-5 mb-3">Titles - results for "<i>${l}</i>"</h4>
        <div class="title-results">
          ${mt(s,l)}
        </div>
      </div>
    `}catch(b){if(b.name==="AbortError"){console.log("Search cancelled due to new input");return}t.innerHTML=`
      <div class="column">
        <div class="notification is-danger">
          Error performing search: ${b.message}
        </div>
      </div>
    `}finally{O?.signal===a&&(O=null)}};async function X(u,l=!0){u.forEach(async a=>{const t=a.uri.split("/").pop(),e=`https://id.loc.gov/resources/instances/${t}.bibframe_raw.json`;try{const r=await fetch(e);if(!r.ok)throw new Error(`HTTP ${r.status}`);const k=(await r.json()).find(g=>g["@id"]===`http://id.loc.gov/resources/instances/${t}`);let y="",s="";if(k){if(k["http://id.loc.gov/ontologies/bibframe/publicationStatement"]){y=k["http://id.loc.gov/ontologies/bibframe/publicationStatement"][0]?.["@value"]||"";const g=y.match(/\b(c?)(1[5-9]\d{2}|20[0-2]\d)\b/g);if(g&&g.length>0){const D=g.map(C=>{const v=C.startsWith("c"),m=parseInt(C.replace("c",""));return{original:C,numeric:m,hasC:v}}).reduce((C,v)=>v.numeric>C.numeric?v:C);y=y.replace(new RegExp(`\\b${D.original}\\b`,"g"),`<strong>${D.original}</strong>`)}}k["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"]&&(s=k["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"][0]?.["@value"]||"")}const S=document.querySelector(`.instance-details[data-work-id="${t}"]`);S&&(y||s?S.innerHTML=`
            ${s?`<p class="is-size-7 has-text-grey">By: ${s}</p>`:""}
            ${y&&l?`<p class="is-size-7 has-text-grey"><strong>Published:</strong> ${y}</p>`:""}
          `:S.innerHTML='<p class="is-size-7 has-text-grey-light">No instance details available</p>')}catch(r){console.error(`Error fetching instance for work ${t}:`,r);const b=document.querySelector(`.instance-details[data-work-id="${t}"]`);b&&(b.innerHTML='<p class="is-size-7 has-text-grey-light">Details not available</p>')}})}async function Q(u,l){const a=document.getElementById("search-results");a&&a.scrollIntoView({behavior:"smooth",block:"start"}),console.log(`[CONTRIBUTOR] Processing works for: ${l} (${u})`);const t=document.querySelector("#search-results .column:last-child .title-results"),e=document.querySelector("#search-results .column:last-child h4");document.querySelector("#search-results .column:last-child");const r=document.getElementById("search");r&&r.value,t&&(t.innerHTML=`
      <div class="progress-container">
        <div class="progress">
          <div class="progress-bar" style="width: 0%"></div>
        </div>
        <div class="progress-text">Loading contributor works...</div>
      </div>
    `);const b=(y,s)=>{const S=t?.querySelector(".progress-bar"),g=t?.querySelector(".progress-text");S&&(S.style.width=`${y}%`),g&&(g.textContent=s)};e&&(e.innerHTML=`
      <span style="display: flex; align-items: center; justify-content: space-between;">
        <span>Titles - Please Select Work</span>
        <button class="button is-small is-light" onclick="(() => { const input = document.getElementById('search'); if (input && input.value) { performSearches(input.value); } })()">
          <span>← Back</span>
        </button>
      </span>
    `);try{let f=function(w){return w.toLowerCase().replace(/[.,;:!?\-–—'"'""\[\](){}]/g,"").replace(/\s+/g," ").trim()};var k=f;b(5,"Fetching contributor information...");const y=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${u}&page=0`,S=await(await fetch(y)).json(),g=Math.min(S.summary.totalPages,49);b(10,`Found ${S.summary.totalPages+1} pages of works...`);const x=[];for(let w=0;w<=g;w++){const i=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${u}&page=${w}`;x.push(fetch(i).then(B=>B.json()))}b(15,`Loading ${g+1} pages of works...`);const D=await Promise.all(x);b(30,"Processing work records...");const C=D.flatMap(w=>w.results||[]),v=new Map;C.forEach(w=>{v.has(w.uri)||v.set(w.uri,w)});const m=Array.from(v.values());console.log(`Total results before dedup: ${C.length}, after dedup: ${m.length}`),console.log(`Checking types for ${m.length} works...`),b(35,`Fetching details for ${m.length} works...`);let E=0;const o=m.map(async w=>{const i=w.uri.split("/").pop();try{const A=await(await fetch(`https://id.loc.gov/resources/works/${i}.bibframe_raw.json`)).json();E++;const j=35+Math.round(E/m.length*55);b(j,`Loading work details... (${E}/${m.length})`);const M=A.find(n=>n["@id"]===w.uri);let U=!1,_=!1,W=null;if(M)if(console.log(`Work ${i}:`,M["@type"]),M["@type"]&&Array.isArray(M["@type"])){if(U=M["@type"].includes("http://id.loc.gov/ontologies/bibframe/Text"),_=!U&&M["@type"].length>1,_){const n=M["@type"].find(p=>{const d=p.split("/").pop();return d!=="Work"&&d!=="Monograph"&&d!=="Text"});n&&(W=n.split("/").pop())}console.log(`  Has Text type: ${U}, Is Non-Text: ${_}, Work Type: ${W}`)}else console.log("  No @type field found");else console.log(`  Main work not found for ${w.uri}`);return{...w,isText:U,isNonText:_,workType:W,bibframeData:A}}catch(B){return console.error(`  Error fetching ${i}:`,B),{...w,isText:!0,isNonText:!1,workType:null,bibframeData:null}}}),c=await Promise.all(o);b(95,"Organizing results..."),window.contributorWorksBibframeData={},c.forEach(w=>{window.contributorWorksBibframeData[w.uri]=w.bibframeData});const $={},T={},I={};let R=0;c.forEach(w=>{let i=w.label;const B=w.uri.split("/").pop();if(console.log(`[TITLE DEBUG ${B}] Starting title extraction`),console.log(`[TITLE DEBUG ${B}] Initial label from API:`,w.label),console.log(`[TITLE DEBUG ${B}] Known contributor:`,l),i)console.log(`[TITLE DEBUG ${B}] ✓ Using label from API: "${i}"`);else if(console.log(`[TITLE DEBUG ${B}] No label from API, checking bibframe data`),w.bibframeData){console.log(`[TITLE DEBUG ${B}] Bibframe data exists, searching for work object`);const U=w.bibframeData.find(_=>_["@id"]===w.uri);if(U){console.log(`[TITLE DEBUG ${B}] Found main work object`);const _=U["http://id.loc.gov/ontologies/bflc/aap"];if(_&&_[0])i=_[0]["@value"],console.log(`[TITLE DEBUG ${B}] ✓ Using AAP: "${i}"`);else{console.log(`[TITLE DEBUG ${B}] No AAP found, trying title property`);const W=U["http://id.loc.gov/ontologies/bibframe/title"];if(W&&W[0]){const n=W[0]["@id"];console.log(`[TITLE DEBUG ${B}] Found title reference: ${n}`);const p=w.bibframeData.find(d=>d["@id"]===n);if(p){console.log(`[TITLE DEBUG ${B}] Found title object`);const d=p["http://id.loc.gov/ontologies/bibframe/mainTitle"];d&&d[0]?(i=d[0]["@value"],console.log(`[TITLE DEBUG ${B}] ✓ Using mainTitle: "${i}"`)):console.log(`[TITLE DEBUG ${B}] No mainTitle in title object`)}else console.log(`[TITLE DEBUG ${B}] Could not find title object with ID: ${n}`)}else console.log(`[TITLE DEBUG ${B}] No title property in main work`)}}else console.log(`[TITLE DEBUG ${B}] Could not find main work object in bibframe data`)}else console.log(`[TITLE DEBUG ${B}] No bibframe data available`);i?console.log(`[TITLE DEBUG ${B}] Final title before processing: "${i}"`):(console.warn(`[TITLE DEBUG ${B}] ⚠️ No title found anywhere, using ID fallback`),i=`Work ${B}`);const A=i;let j=!1;if(l&&i.startsWith(l)){let U=i.substring(l.length);U=U.replace(/^[\s.,:\-–—]+/,""),U&&U.length>0&&(i=U.trim(),console.log(`[TITLE DEBUG] Used known contributor name to extract: "${i}"`),j=!0)}else if(l){const U=l.split(",")[0].trim();if(i.startsWith(U)){const _=[new RegExp(`^${U.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}[^.]*\\.s+`),new RegExp(`^${U.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}[^.]*[-–]s+`)];for(const W of _){const n=i.match(W);if(n){i=i.substring(n[0].length),console.log(`[TITLE DEBUG] Used partial contributor match to extract: "${i}"`),j=!0;break}}}}if(!j&&i.match(/^[^,]+,\s*[^,\.]+/)){const U=i.match(/^[^,]+,\s*[^,]+(?:,\s*(?:Sir|Dr|Prof|Mr|Mrs|Ms|Miss|Lord|Lady|Baron|Count|Duke)[^,]*)?(?:,\s*\d{4}[-–](?:\d{4})?)?\s*\.\s+/);if(U)i=i.substring(U[0].length),console.log(`[TITLE DEBUG] Matched author with title/honorific pattern, extracted: "${i}"`),j=!0;else{const _=i.match(/^[^,]+,\s*[^,]+,\s*\d{4}[-–](?:\d{4})?\s*[-.]?\s*/);if(_)i=i.substring(_[0].length),console.log(`[TITLE DEBUG] Matched author with dates pattern, extracted: "${i}"`),j=!0;else{const W=i.match(/^[^,]+,\s*(?:[A-Z]\.?\s*)+(?:[A-Za-z]+\s*)?(?:\([^)]+\))?\s*\.\s+([A-Z])/);if(W){const n=i.indexOf(W[1],W.index);i=i.substring(n),console.log(`[TITLE DEBUG] Matched name with initials, extracted: "${i}"`),j=!0}else{const n=i.match(/^[^,]+,\s*[^.]+\.\s+/);n&&(i=i.substring(n[0].length),console.log(`[TITLE DEBUG] Matched last period pattern, extracted: "${i}"`),j=!0)}}}if(!j){if(i&&i.match(/^[^,]+,\s*[^,\.]+/)){const _=i.match(/\d{4}[-–]\d{0,4}\s+/),W=i.match(/\d{4}[-–]\s+/);_?i=i.substring(_.index+_[0].length):W&&(i=i.substring(W.index+W[0].length))}if((!i||i.match(/^[^,]+,\s*[^,\.]+/))&&(A.match(/,/g)||[]).length>=1){const W=A.indexOf(","),p=A.substring(W+1).trim().search(/[\s,]/);if(p>-1){const d=W+1+p+1,h=A.substring(d).trim();h&&!h.match(/^[^,]+,\s*[^,]+/)&&(i=h,console.log(`[TITLE DEBUG] Used fallback pattern, extracted: "${i}"`))}}}}const M=f(i);I[M]||(I[M]={}),I[M][i]||(I[M][i]=0),I[M][i]++,w.isNonText&&(R++,console.log(`Non-text work found: ${i}`)),w.displayTitle=i,w.normalizedTitle=M,console.log(`[TITLE DEBUG ${B}] After processing:`),console.log(`[TITLE DEBUG ${B}]   Display title: "${w.displayTitle}"`),console.log(`[TITLE DEBUG ${B}]   Normalized: "${w.normalizedTitle}"`)});const L=new Set;c.forEach(w=>{if(L.has(w.uri)){console.log(`Skipping duplicate URI: ${w.uri}`);return}L.add(w.uri);const i=w.normalizedTitle,B=w.isNonText?T:$;let A=w.displayTitle;if(I[i]){let j=0;Object.entries(I[i]).forEach(([M,U])=>{U>j&&(j=U,A=M)})}B[i]||(B[i]={displayTitle:A,works:[]}),B[i].works.push(w)}),console.log(`Total works: ${c.length}, Non-text works: ${R}`);const P=Object.keys($).sort((w,i)=>$[w].displayTitle.localeCompare($[i].displayTitle)),H=Object.keys(T).sort((w,i)=>T[w].displayTitle.localeCompare(T[i].displayTitle));if(console.log(`Text titles: ${P.length}, Non-text titles: ${H.length}`),t)if(P.length===0&&H.length===0)t.innerHTML='<p class="has-text-grey">No works found</p>';else{let w="";const i=P.filter(j=>$[j].works.length>1),B=P.filter(j=>$[j].works.length===1);i.length>0&&(w+='<p class="has-text-primary has-text-weight-semibold mb-3">Multiple Instances</p>',w+=i.map(j=>{const M=$[j],U=M.works,_=M.displayTitle,W=U[0],n=U.map(p=>p.uri).join(",");return(!_||_.trim()==="")&&(console.error(`[TITLE DEBUG] EMPTY TITLE for group with key "${j}"`),console.error("[TITLE DEBUG] Works in group:",U),console.error("[TITLE DEBUG] Group data:",M)),`
              <div class="box p-3 mb-2 collapsed-work-result" data-uri="${W.uri}" data-all-uris="${n}" data-title="${_.replace(/"/g,"&quot;")}" style="cursor: pointer;">
                <p class="has-text-weight-semibold">${_}</p>
                <p class="is-size-7 has-text-grey">${U.length} instances</p>
                <div class="instance-details" data-work-id="${W.uri.split("/").pop()}">
                  <p class="is-size-7 has-text-grey-light">Loading details...</p>
                </div>
              </div>
            `}).join("")),B.length>0&&(i.length>0&&(w+='<hr style="margin: 1.5rem 0;">'),w+='<p class="has-text-primary has-text-weight-semibold mb-3">Single Instance</p>',w+=B.map(j=>{const M=$[j],U=M.works,_=M.displayTitle,W=U[0];return`
              <div class="box p-3 mb-2 title-result single-instance" data-uri="${W.uri}" style="cursor: pointer;">
                <p class="has-text-weight-semibold">${_}</p>
                <div class="instance-details" data-work-id="${W.uri.split("/").pop()}">
                  <p class="is-size-7 has-text-grey-light">Loading details...</p>
                </div>
              </div>
            `}).join("")),H.length>0&&(w+=`
            <hr style="margin: 1.5rem 0;">
            <p class="has-text-grey has-text-weight-semibold mb-3">Non-Text Works</p>
          `,w+=H.map(j=>{const M=T[j],U=M.works,_=M.displayTitle,W=U[0],n=U.map(d=>d.uri).join(","),p=W.workType;return`
              <div class="box p-3 mb-2 non-text-work ${U.length>1?"collapsed-work-result":"title-result single-instance"}" data-uri="${W.uri}" ${U.length>1?`data-all-uris="${n}" data-title="${_.replace(/"/g,"&quot;")}"`:""} style="cursor: pointer;">
                <p class="has-text-weight-semibold">
                  ${_}
                  ${p?`<span class="is-size-7 has-text-grey-light ml-2">[${p}]</span>`:""}
                </p>
                ${U.length>1?`<p class="is-size-7 has-text-grey">${U.length} instances</p>`:""}
                <div class="instance-details" data-work-id="${W.uri.split("/").pop()}">
                  <p class="is-size-7 has-text-grey-light">Loading details...</p>
                </div>
              </div>
            `}).join("")),t.innerHTML=w;const A=[...i.map(j=>$[j].works[0]),...B.map(j=>$[j].works[0]),...H.map(j=>T[j].works[0])];X(A,!1)}}catch(y){console.error("Error fetching contributor works:",y),t&&(t.innerHTML='<p class="has-text-danger">Error loading contributor works</p>')}}window.handleCollapsedWorkClick=async function(l,a){console.log("[handleCollapsedWorkClick] Called with:",{allUris:l,title:a}),N={type:"all-instances",data:{allUris:l,title:a}},console.log("[handleCollapsedWorkClick] Set navigation context:",N);let t=document.getElementById("search-results");console.log("[handleCollapsedWorkClick] Results container exists?",!!t);const e=t&&t.querySelector(".contributor-results")&&t.querySelector(".title-results");t&&(console.log("[handleCollapsedWorkClick] Results container HTML:",t.innerHTML.substring(0,200)),console.log("[handleCollapsedWorkClick] Has search structure?",e)),!t||!e?(console.log("[handleCollapsedWorkClick] Recreating search results structure"),t||(t=J()),t.innerHTML=`
      <div class="columns">
        <div class="column is-4">
          <h4 class="title is-5 mb-3">Contributors</h4>
          <div class="contributor-results">
            <p class="has-text-grey">Search to see contributors</p>
          </div>
        </div>
        <div class="column is-8">
          <h4 class="title is-5 mb-3">Titles - Please Select Instance</h4>
          <div class="title-results">
            <div class="working-message">Loading all instances...</div>
          </div>
        </div>
      </div>
    `):console.log("[handleCollapsedWorkClick] Using existing search results structure"),t&&t.scrollIntoView({behavior:"smooth",block:"start"});const r=document.querySelector("#search-results .column:last-child .title-results"),b=document.querySelector("#search-results .column:last-child h4");if(console.log("[handleCollapsedWorkClick] Title column found?",!!r),console.log("[handleCollapsedWorkClick] Title header found?",!!b),r?(console.log("[handleCollapsedWorkClick] Setting loading state"),r.innerHTML='<div class="working-message">Loading all instances...</div>'):console.error("[handleCollapsedWorkClick] Could not find title column!"),b){b.innerHTML=`
      <span style="display: flex; align-items: center; justify-content: space-between;">
        <span>Titles - Please Select Instance</span>
        <button class="button is-small is-light" id="back-to-works">
          <span>← Back</span>
        </button>
      </span>
    `;const k=document.getElementById("back-to-works");k&&k.addEventListener("click",()=>{const y=document.querySelector('.contributor-box[data-selected="true"]');if(y){const s=y.dataset.token,S=y.dataset.label;s&&s.startsWith("n")&&Q(s,S)}else{const s=document.getElementById("search");s&&s.value&&performSearches(s.value)}})}console.log("[handleCollapsedWorkClick] Starting to fetch instances");try{const k=l.split(",");console.log("[handleCollapsedWorkClick] Processing",k.length,"URIs");const y=k.map(async S=>{const g=S.split("/").pop(),x=S.replace("/resources/works/","/resources/instances/"),D=`https://id.loc.gov/resources/instances/${g}.bibframe_raw.json`;try{const C=await fetch(D);if(!C.ok)return{"@id":x,label:`Instance ${g}`,workId:g};const v=await C.json(),m=v.find(o=>o["@id"]===x);let E=`Instance ${g}`;if(m){if(m["http://www.w3.org/2000/01/rdf-schema#label"])E=m["http://www.w3.org/2000/01/rdf-schema#label"][0]["@value"];else if(m["http://id.loc.gov/ontologies/bibframe/title"]){const o=m["http://id.loc.gov/ontologies/bibframe/title"][0]["@id"],c=v.find(f=>f["@id"]===o);c&&c["http://id.loc.gov/ontologies/bibframe/mainTitle"]&&(E=c["http://id.loc.gov/ontologies/bibframe/mainTitle"][0]["@value"])}}return{"@id":x,label:E,workId:g,data:m}}catch(C){return console.error(`Error fetching instance ${g}:`,C),{"@id":x,label:`Instance ${g}`,workId:g}}}),s=await Promise.all(y);if(r)if(s.length===0)r.innerHTML='<p class="has-text-grey">No instances found</p>';else{let S=`<p class="has-text-primary has-text-weight-semibold mb-3">${a} - All Instances</p>`;s.sort((g,x)=>{const D=parseInt(g["@id"].split("/").pop())||0,C=parseInt(x["@id"].split("/").pop())||0;return D-C}),S+=s.map(g=>{const x=g["@id"],D=g.label,C=g.workId;let v="",m="";if(g.data){if(g.data["http://id.loc.gov/ontologies/bibframe/publicationStatement"]){v=g.data["http://id.loc.gov/ontologies/bibframe/publicationStatement"][0]?.["@value"]||"";const E=v.match(/\b(c?)(1[5-9]\d{2}|20[0-2]\d)\b/g);if(E&&E.length>0){const c=E.map(f=>{const $=f.startsWith("c"),T=parseInt(f.replace("c",""));return{original:f,numeric:T,hasC:$}}).reduce((f,$)=>$.numeric>f.numeric?$:f);v=v.replace(new RegExp(`\\b${c.original}\\b`,"g"),`<strong>${c.original}</strong>`)}}g.data["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"]&&(m=g.data["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"][0]?.["@value"]||"")}return`
            <div class="box p-3 mb-2 title-result" data-uri="${x}" style="cursor: pointer;">
              <p class="has-text-weight-semibold">${D}</p>
              <div class="instance-details">
                ${m?`<p class="is-size-7 has-text-grey">By: ${m}</p>`:""}
                ${v?`<p class="is-size-7 has-text-grey"><strong>Published:</strong> ${v}</p>`:""}
                ${!m&&!v?'<p class="is-size-7 has-text-grey-light">No additional details available</p>':""}
              </div>
            </div>
          `}).join(""),r.innerHTML=S}console.log("[handleCollapsedWorkClick] Completed successfully")}catch(k){console.error("[handleCollapsedWorkClick] Error:",k),console.error("[handleCollapsedWorkClick] Error stack:",k.stack);const y=document.querySelector("#search-results .column:last-child .title-results");y&&(y.innerHTML='<p class="has-text-danger">Error loading instances</p>')}};async function bt(u,l){const a=document.getElementById("search-results");a&&a.scrollIntoView({behavior:"smooth",block:"start"});const t=u.split("/").pop(),e=`https://id.loc.gov/resources/works/${t}.bibframe_raw.json`,r=document.getElementById("search"),b=r?r.value.toLowerCase():"";try{const y=await(await fetch(e)).json(),s=y.find(S=>S["@id"]===u);if(s&&s["http://id.loc.gov/ontologies/bibframe/contribution"]){const S=s["http://id.loc.gov/ontologies/bibframe/contribution"][0]["@id"],g=y.find(x=>x["@id"]===S);if(g&&g["http://id.loc.gov/ontologies/bibframe/agent"]){let x=g["http://id.loc.gov/ontologies/bibframe/agent"][0]["@id"];if(x.startsWith("_:")){const L=`https://id.loc.gov/resources/works/${t}.bibframe.json`;try{const H=await(await fetch(L)).json(),w=H.find(i=>i["@id"]===u);if(w&&w["http://id.loc.gov/ontologies/bibframe/contribution"]){const i=w["http://id.loc.gov/ontologies/bibframe/contribution"][0]["@id"],B=H.find(A=>A["@id"]===i);B&&B["http://id.loc.gov/ontologies/bibframe/agent"]&&(x=B["http://id.loc.gov/ontologies/bibframe/agent"][0]["@id"])}}catch(P){console.error("Error fetching processed bibframe data:",P)}}if(x.startsWith("_:"))throw new Error("Unable to resolve contributor - blank node found");const D=x.split("/").pop(),C=document.querySelector("#search-results .column:last-child .title-results"),v=document.querySelector("#search-results .column:last-child");C&&v&&(v.classList.add("slide-transition"),C.innerHTML='<div class="working-message">Working...</div>',setTimeout(()=>{v.classList.remove("slide-transition")},400));const m=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${D}&page=0`,o=await(await fetch(m)).json(),c=Math.min(o.summary.totalPages,19),f=[];for(let L=0;L<=c;L++){const P=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${D}&page=${L}`;f.push(fetch(P).then(H=>H.json()))}const R=(await Promise.all(f)).flatMap(L=>L.results||[]).map(L=>{const P=L.label.toLowerCase(),H=b?G(b,P):1/0,w=l?G(l.toLowerCase(),P):1/0,i=Math.min(H,w);return{...L,distance:i}}).sort((L,P)=>L.distance-P.distance).slice(0,20);if(C)if(R.length===0)C.innerHTML='<p class="has-text-grey">No matching works found</p>';else{const L=document.querySelector("#search-results .column:last-child h4");L&&(L.innerHTML=`
                <span style="display: flex; align-items: center; justify-content: space-between;">
                  <span>Titles - Please Select Instance</span>
                  <button class="button is-small is-light" onclick="(() => { const input = document.getElementById('search'); if (input && input.value) { performSearches(input.value); } })()">
                    <span>← Back</span>
                  </button>
                </span>
              `);const P=R.filter(i=>i.distance<=5),H=R.filter(i=>i.distance>5);P.sort((i,B)=>{const A=parseInt(i.uri.split("/").pop())||0,j=parseInt(B.uri.split("/").pop())||0;return A-j});let w="";P.length>0&&(w+=P.map(i=>`
                <div class="box p-3 mb-2 title-result instance-selection" data-uri="${i.uri}" style="cursor: pointer;">
                  <p class="has-text-weight-semibold">${i.label}</p>
                  <div class="instance-details" data-work-id="${i.uri.split("/").pop()}">
                    <p class="is-size-7 has-text-grey-light">Loading details...</p>
                  </div>
                </div>
              `).join("")),H.length>0&&(w+=`
                <hr style="margin: 1.5rem 0;">
                <p class="has-text-grey has-text-weight-semibold mb-3">Poor Matches</p>
              `,w+=H.map(i=>`
                <div class="box p-3 mb-2 title-result instance-selection" data-uri="${i.uri}" style="cursor: pointer;">
                  <p class="has-text-weight-semibold">${i.label}</p>
                  <div class="instance-details" data-work-id="${i.uri.split("/").pop()}">
                    <p class="is-size-7 has-text-grey-light">Loading details...</p>
                  </div>
                </div>
              `).join("")),C.innerHTML=w,X(R)}}}}catch(k){console.error("Error fetching bibframe data:",k);const y=document.querySelector("#search-results .column:last-child .title-results");y&&(y.innerHTML='<p class="has-text-danger">Error loading related works</p>',window.excludedUris||(window.excludedUris=new Set),window.excludedUris.add(u),setTimeout(()=>{const s=document.getElementById("search");s&&s.value&&performSearches(s.value)},1e3))}}async function Y(u){console.log("[handleInstanceClick] Called with:",u),console.log("[handleInstanceClick] Current navigation context:",N);const l=document.getElementById("search");if(l){const b=l.closest(".field").parentElement;b&&b.scrollIntoView({behavior:"smooth",block:"start"})}const a=u.split("/").pop(),t=u.replace("/instances/","/works/"),e=t.split("/").pop(),r=document.getElementById("search-results");r.innerHTML=`
    <div class="columns">
      <div class="column is-8">
        <div class="shimmer-container">
          <div class="shimmer shimmer-title"></div>
          <div class="box">
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line medium"></div>
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line short"></div>
            <br>
            <div class="shimmer shimmer-line medium"></div>
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line medium"></div>
            <br>
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line short"></div>
            <div class="shimmer shimmer-line medium"></div>
          </div>
        </div>
      </div>
      <div class="column is-4">
        <div class="shimmer-container">
          <div class="shimmer shimmer-button"></div>
          <div class="shimmer shimmer-button"></div>
          <br><br>
          <div class="shimmer shimmer-box"></div>
        </div>
      </div>
    </div>
  `;try{const[b,k]=await Promise.all([fetch(`https://id.loc.gov/resources/works/${e}.bibframe.json`),fetch(`https://id.loc.gov/resources/instances/${a}.bibframe.json`)]),y=await b.json(),s=await k.json(),S=await vt(y,s,t,u);r.innerHTML=`
      <div class="columns">
        <div class="column is-8">
          <h3 class="title is-4 mb-4">Instance Details</h3>
          <div class="box">
            ${yt(S)}
          </div>
        </div>
        <div class="column is-4">
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button class="button is-small is-light" id="back-button-instance">
              <span>${N.type==="all-instances"?"← Back to All Instances":"← Back to Search"}</span>
            </button>
            <button class="button is-primary" onclick="window.open('https://bibframe.org/marva/quartz/?action=load&url=https://id.loc.gov/resources/instances/${a}.cbd.rdf&profile=lc:RT:bf2:Monograph:Instance', '_blank')">
              Open in Marva Editor
            </button>
            <button class="button is-info" onclick="window.open('${t}', '_blank')">
              View on id.loc.gov
            </button>
          </div>
        </div>
      </div>
    `;const g=document.getElementById("back-button-instance");g?g.addEventListener("click",()=>{if(console.log("[BACK BUTTON] Navigation context:",N),N.type==="all-instances"){console.log("[BACK BUTTON] Going back to all instances"),console.log("[BACK BUTTON] URIs:",N.data.allUris),console.log("[BACK BUTTON] Title:",N.data.title);try{window.handleCollapsedWorkClick(N.data.allUris,N.data.title)}catch(x){console.error("[BACK BUTTON] Error calling handleCollapsedWorkClick:",x)}}else{console.log("[BACK BUTTON] Going back to search");const x=document.getElementById("search");x&&x.value&&performSearches(x.value)}}):console.error("[BACK BUTTON] Could not find back button element")}catch(b){console.error("Error loading instance details:",b),r.innerHTML=`
      <div class="notification is-danger">
        Error loading instance details. Please try again.
        <button class="button is-small is-light mt-3" id="error-back-button">
          <span>${N.type==="all-instances"?"← Back to All Instances":"← Back to Search"}</span>
        </button>
      </div>
    `;const k=document.getElementById("error-back-button");k&&k.addEventListener("click",()=>{if(N.type==="all-instances")window.handleCollapsedWorkClick(N.data.allUris,N.data.title);else{const y=document.getElementById("search");y&&y.value&&performSearches(y.value)}})}}async function vt(u,l,a,t){const e={title:"",contributors:[],publicationStatement:"",extent:"",isbn:[],language:[],subjects:[],notes:[],workUri:a,instanceUri:t},r=u.find(k=>k["@id"]===a)||u[0],b=l.find(k=>k["@id"]===t)||l[0];if(r){const k=r["http://id.loc.gov/ontologies/bibframe/title"];if(k&&k[0]){const v=k[0]["@id"],m=u.find(E=>E["@id"]===v);if(m){const E=m["http://id.loc.gov/ontologies/bibframe/mainTitle"],o=m["http://id.loc.gov/ontologies/bibframe/subtitle"];e.title=E?E[0]["@value"]:"",o&&(e.title+=": "+o[0]["@value"])}}const s=(r["http://id.loc.gov/ontologies/bibframe/contribution"]||[]).map(async v=>{const m=v["@id"],E=u.find(o=>o["@id"]===m);if(E){const o=E["http://id.loc.gov/ontologies/bibframe/agent"];if(o&&o[0]){const c=o[0]["@id"];if(c.startsWith("_:")){const f=u.find($=>$["@id"]===c);if(f){const $=f["http://www.w3.org/2000/01/rdf-schema#label"];if($&&$[0])return{name:$[0]["@value"],uri:null}}}else{const f=c.split("/").pop();try{console.log(`Fetching contributor data for LCCN: ${f}, URI: ${c}`);const $=await fetch(`https://id.loc.gov/authorities/names/${f}.json`);if($.ok){const T=await $.json();console.log(`Received data for ${f}, array length: ${T.length}`);const I=`http://id.loc.gov/authorities/names/${f}`,R=T.find(L=>(L["@id"]===c||L["@id"]===I)&&L["@type"]&&(Array.isArray(L["@type"])?L["@type"].includes("http://www.loc.gov/mads/rdf/v1#Authority"):L["@type"]==="http://www.loc.gov/mads/rdf/v1#Authority"));if(console.log(`Found agent for ${f}:`,R?"Yes":"No"),console.log(`Looking for URI: ${c} or ${I}`),R&&R["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"]){const L=R["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"];if(console.log(`Found authoritativeLabel for ${f}:`,L),L&&L.length>0&&L[0]["@value"]){const P=L[0]["@value"];return console.log(`Returning name for ${f}: ${P}`),{name:P,uri:c}}}else console.log(`No agent or authoritativeLabel found for ${f}`)}else console.log(`Failed to fetch data for ${f}, status: ${$.status}`)}catch($){console.error(`Error fetching contributor ${f}:`,$)}return console.log(`Using fallback LCCN for ${f}`),{name:f,uri:c}}}}return null}),S=await Promise.all(s);e.contributors=S.filter(v=>v!==null),(r["http://id.loc.gov/ontologies/bibframe/language"]||[]).forEach(v=>{const m=v["@id"];m&&e.language.push(m.split("/").pop())});const D=(r["http://id.loc.gov/ontologies/bibframe/subject"]||[]).map(async v=>{const m=v["@id"];if(m)if(m.startsWith("_:")){const E=u.find(o=>o["@id"]===m);if(E){const o=E["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"],c=E["http://www.w3.org/2000/01/rdf-schema#label"];if(o&&o[0])return{label:o[0]["@value"],uri:null};if(c&&c[0])return{label:c[0]["@value"],uri:null}}return null}else{const E=m.split("/").pop(),o=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(E),c=o?`https://id.loc.gov/resources/hubs/${E}.json`:`https://id.loc.gov/authorities/subjects/${E}.json`;try{const f=await fetch(c);if(f.ok){const T=(await f.json()).find(I=>I["@id"]===m);if(T)if(o){const I=T["http://id.loc.gov/ontologies/bflc/aap"];if(I&&I[0])return{label:I[0]["@value"],uri:m}}else{const I=T["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"];if(I&&I[0])return{label:I[0]["@value"],uri:m}}}}catch(f){console.error(`Error fetching subject ${E}:`,f)}return{label:E,uri:m}}return null}),C=await Promise.all(D);e.subjects=C.filter(v=>v!==null)}if(b){const k=b["http://id.loc.gov/ontologies/bibframe/publicationStatement"];k&&(e.publicationStatement=k[0]["@value"]);const y=b["http://id.loc.gov/ontologies/bibframe/extent"];if(y&&y[0]){const S=y[0]["@id"],g=l.find(x=>x["@id"]===S);if(g){const x=g["http://www.w3.org/2000/01/rdf-schema#label"];x&&(e.extent=x[0]["@value"])}}(b["http://id.loc.gov/ontologies/bibframe/identifiedBy"]||[]).forEach(S=>{const g=l.find(x=>x["@id"]===S["@id"]);if(g&&g["@type"]&&g["@type"].includes("http://id.loc.gov/ontologies/bibframe/Isbn")){const x=g["http://www.w3.org/1999/02/22-rdf-syntax-ns#value"];x&&e.isbn.push(x[0]["@value"])}})}return e}function yt(u){let l='<div class="content">';return u.title&&(l+=`<h4 class="title is-5">${u.title}</h4>`),u.contributors.length>0&&(l+='<div class="mb-3">',l+='<p class="mb-2"><strong>Contributors:</strong></p>',l+="<ul>",u.contributors.forEach(a=>{a.uri?l+=`<li><a href="${a.uri}" target="_blank">${a.name}</a></li>`:l+=`<li>${a.name}</li>`}),l+="</ul>",l+="</div>"),u.publicationStatement&&(l+=`<p><strong>Publication:</strong> ${u.publicationStatement}</p>`),u.extent&&(l+=`<p><strong>Extent:</strong> ${u.extent}</p>`),u.isbn.length>0&&(l+=`<p><strong>ISBN:</strong> ${u.isbn.join(", ")}</p>`),u.language.length>0&&(l+=`<p><strong>Language:</strong> ${u.language.join(", ")}</p>`),u.subjects.length>0&&(l+='<div class="mb-3">',l+='<p class="mb-2"><strong>Subjects:</strong></p>',l+="<ul>",u.subjects.slice(0,7).forEach(a=>{a.uri?l+=`<li><a href="${a.uri}" target="_blank">${a.label}</a></li>`:l+=`<li>${a.label}</li>`}),l+="</ul>",l+="</div>"),l+="</div>",l}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('form[action="/marva/quartz"], form[action*="marva"]').forEach(a=>{console.log("Found form with action:",a.action),a.addEventListener("submit",t=>{t.preventDefault();const e=new FormData(a),r=new URLSearchParams(e),k=(a.action.startsWith("http")?a.action:window.location.origin+a.action)+"?"+r.toString();console.log("Form submission intercepted, opening:",k),window.open(k,"_blank")})});const l=document.getElementById("search");if(l){const a=pt(t=>{performSearches(t.target.value)},500);l.addEventListener("input",a)}document.addEventListener("click",a=>{const t=a.target.closest(".collapsed-work-result");if(t){const b=t.dataset.allUris,k=t.dataset.title;b&&k&&handleCollapsedWorkClick(b,k);return}const e=a.target.closest(".title-result");if(e){const b=e.dataset.uri;if((e.classList.contains("single-instance")||e.classList.contains("instance-selection"))&&b.includes("/works/")){const k=b.replace("/works/","/instances/");Y(k)}else if(b.includes("/instances/"))Y(b);else{const k=e.querySelector(".has-text-weight-semibold"),y=k?k.textContent:"";bt(b,y)}}const r=a.target.closest(".contributor-box");if(r){const b=r.dataset.token,k=r.dataset.label;b&&b.startsWith("n")&&(document.querySelectorAll(".contributor-box").forEach(y=>{y.dataset.selected="false"}),r.dataset.selected="true",Q(b,k))}})});
