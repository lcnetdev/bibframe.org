(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const k of a.addedNodes)k.tagName==="LINK"&&k.rel==="modulepreload"&&t(k)}).observe(document,{childList:!0,subtree:!0});function i(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerPolicy&&(a.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?a.credentials="include":e.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(e){if(e.ep)return;e.ep=!0;const a=i(e);fetch(e.href,a)}})();var F=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function tt(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}function et(c){if(Object.prototype.hasOwnProperty.call(c,"__esModule"))return c;var n=c.default;if(typeof n=="function"){var i=function t(){var e=!1;try{e=this instanceof t}catch{}return e?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};i.prototype=n.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(c).forEach(function(t){var e=Object.getOwnPropertyDescriptor(c,t);Object.defineProperty(i,t,e.get?e:{enumerable:!0,get:function(){return c[t]}})}),i}var z={exports:{}};function st(c){throw new Error('Could not dynamically require "'+c+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var G={exports:{}};const ot={},nt=Object.freeze(Object.defineProperty({__proto__:null,default:ot},Symbol.toStringTag,{value:"Module"})),it=et(nt);var rt=G.exports,V;function at(){return V||(V=1,(function(c,n){(function(i,t){c.exports=t()})(rt,function(){var i=i||(function(t,e){var a;if(typeof window<"u"&&window.crypto&&(a=window.crypto),typeof self<"u"&&self.crypto&&(a=self.crypto),typeof globalThis<"u"&&globalThis.crypto&&(a=globalThis.crypto),!a&&typeof window<"u"&&window.msCrypto&&(a=window.msCrypto),!a&&typeof F<"u"&&F.crypto&&(a=F.crypto),!a&&typeof st=="function")try{a=it}catch{}var k=function(){if(a){if(typeof a.getRandomValues=="function")try{return a.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof a.randomBytes=="function")try{return a.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},v=Object.create||(function(){function s(){}return function(d){var f;return s.prototype=d,f=new s,s.prototype=null,f}})(),y={},o=y.lib={},S=o.Base=(function(){return{extend:function(s){var d=v(this);return s&&d.mixIn(s),(!d.hasOwnProperty("init")||this.init===d.init)&&(d.init=function(){d.$super.init.apply(this,arguments)}),d.init.prototype=d,d.$super=this,d},create:function(){var s=this.extend();return s.init.apply(s,arguments),s},init:function(){},mixIn:function(s){for(var d in s)s.hasOwnProperty(d)&&(this[d]=s[d]);s.hasOwnProperty("toString")&&(this.toString=s.toString)},clone:function(){return this.init.prototype.extend(this)}}})(),g=o.WordArray=S.extend({init:function(s,d){s=this.words=s||[],d!=e?this.sigBytes=d:this.sigBytes=s.length*4},toString:function(s){return(s||D).stringify(this)},concat:function(s){var d=this.words,f=s.words,$=this.sigBytes,T=s.sigBytes;if(this.clamp(),$%4)for(var E=0;E<T;E++){var R=f[E>>>2]>>>24-E%4*8&255;d[$+E>>>2]|=R<<24-($+E)%4*8}else for(var L=0;L<T;L+=4)d[$+L>>>2]=f[L>>>2];return this.sigBytes+=T,this},clamp:function(){var s=this.words,d=this.sigBytes;s[d>>>2]&=4294967295<<32-d%4*8,s.length=t.ceil(d/4)},clone:function(){var s=S.clone.call(this);return s.words=this.words.slice(0),s},random:function(s){for(var d=[],f=0;f<s;f+=4)d.push(k());return new g.init(d,s)}}),x=y.enc={},D=x.Hex={stringify:function(s){for(var d=s.words,f=s.sigBytes,$=[],T=0;T<f;T++){var E=d[T>>>2]>>>24-T%4*8&255;$.push((E>>>4).toString(16)),$.push((E&15).toString(16))}return $.join("")},parse:function(s){for(var d=s.length,f=[],$=0;$<d;$+=2)f[$>>>3]|=parseInt(s.substr($,2),16)<<24-$%8*4;return new g.init(f,d/2)}},C=x.Latin1={stringify:function(s){for(var d=s.words,f=s.sigBytes,$=[],T=0;T<f;T++){var E=d[T>>>2]>>>24-T%4*8&255;$.push(String.fromCharCode(E))}return $.join("")},parse:function(s){for(var d=s.length,f=[],$=0;$<d;$++)f[$>>>2]|=(s.charCodeAt($)&255)<<24-$%4*8;return new g.init(f,d)}},b=x.Utf8={stringify:function(s){try{return decodeURIComponent(escape(C.stringify(s)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(s){return C.parse(unescape(encodeURIComponent(s)))}},m=o.BufferedBlockAlgorithm=S.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(s){typeof s=="string"&&(s=b.parse(s)),this._data.concat(s),this._nDataBytes+=s.sigBytes},_process:function(s){var d,f=this._data,$=f.words,T=f.sigBytes,E=this.blockSize,R=E*4,L=T/R;s?L=t.ceil(L):L=t.max((L|0)-this._minBufferSize,0);var M=L*E,H=t.min(M*4,T);if(M){for(var w=0;w<M;w+=E)this._doProcessBlock($,w);d=$.splice(0,M),f.sigBytes-=H}return new g.init(d,H)},clone:function(){var s=S.clone.call(this);return s._data=this._data.clone(),s},_minBufferSize:0});o.Hasher=m.extend({cfg:S.extend(),init:function(s){this.cfg=this.cfg.extend(s),this.reset()},reset:function(){m.reset.call(this),this._doReset()},update:function(s){return this._append(s),this._process(),this},finalize:function(s){s&&this._append(s);var d=this._doFinalize();return d},blockSize:16,_createHelper:function(s){return function(d,f){return new s.init(f).finalize(d)}},_createHmacHelper:function(s){return function(d,f){return new I.HMAC.init(s,f).finalize(d)}}});var I=y.algo={};return y})(Math);return i})})(G)),G.exports}var lt=z.exports,K;function ct(){return K||(K=1,(function(c,n){(function(i,t){c.exports=t(at())})(lt,function(i){return(function(t){var e=i,a=e.lib,k=a.WordArray,v=a.Hasher,y=e.algo,o=[];(function(){for(var b=0;b<64;b++)o[b]=t.abs(t.sin(b+1))*4294967296|0})();var S=y.MD5=v.extend({_doReset:function(){this._hash=new k.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(b,m){for(var I=0;I<16;I++){var s=m+I,d=b[s];b[s]=(d<<8|d>>>24)&16711935|(d<<24|d>>>8)&4278255360}var f=this._hash.words,$=b[m+0],T=b[m+1],E=b[m+2],R=b[m+3],L=b[m+4],M=b[m+5],H=b[m+6],w=b[m+7],l=b[m+8],B=b[m+9],N=b[m+10],j=b[m+11],P=b[m+12],U=b[m+13],_=b[m+14],W=b[m+15],r=f[0],p=f[1],u=f[2],h=f[3];r=g(r,p,u,h,$,7,o[0]),h=g(h,r,p,u,T,12,o[1]),u=g(u,h,r,p,E,17,o[2]),p=g(p,u,h,r,R,22,o[3]),r=g(r,p,u,h,L,7,o[4]),h=g(h,r,p,u,M,12,o[5]),u=g(u,h,r,p,H,17,o[6]),p=g(p,u,h,r,w,22,o[7]),r=g(r,p,u,h,l,7,o[8]),h=g(h,r,p,u,B,12,o[9]),u=g(u,h,r,p,N,17,o[10]),p=g(p,u,h,r,j,22,o[11]),r=g(r,p,u,h,P,7,o[12]),h=g(h,r,p,u,U,12,o[13]),u=g(u,h,r,p,_,17,o[14]),p=g(p,u,h,r,W,22,o[15]),r=x(r,p,u,h,T,5,o[16]),h=x(h,r,p,u,H,9,o[17]),u=x(u,h,r,p,j,14,o[18]),p=x(p,u,h,r,$,20,o[19]),r=x(r,p,u,h,M,5,o[20]),h=x(h,r,p,u,N,9,o[21]),u=x(u,h,r,p,W,14,o[22]),p=x(p,u,h,r,L,20,o[23]),r=x(r,p,u,h,B,5,o[24]),h=x(h,r,p,u,_,9,o[25]),u=x(u,h,r,p,R,14,o[26]),p=x(p,u,h,r,l,20,o[27]),r=x(r,p,u,h,U,5,o[28]),h=x(h,r,p,u,E,9,o[29]),u=x(u,h,r,p,w,14,o[30]),p=x(p,u,h,r,P,20,o[31]),r=D(r,p,u,h,M,4,o[32]),h=D(h,r,p,u,l,11,o[33]),u=D(u,h,r,p,j,16,o[34]),p=D(p,u,h,r,_,23,o[35]),r=D(r,p,u,h,T,4,o[36]),h=D(h,r,p,u,L,11,o[37]),u=D(u,h,r,p,w,16,o[38]),p=D(p,u,h,r,N,23,o[39]),r=D(r,p,u,h,U,4,o[40]),h=D(h,r,p,u,$,11,o[41]),u=D(u,h,r,p,R,16,o[42]),p=D(p,u,h,r,H,23,o[43]),r=D(r,p,u,h,B,4,o[44]),h=D(h,r,p,u,P,11,o[45]),u=D(u,h,r,p,W,16,o[46]),p=D(p,u,h,r,E,23,o[47]),r=C(r,p,u,h,$,6,o[48]),h=C(h,r,p,u,w,10,o[49]),u=C(u,h,r,p,_,15,o[50]),p=C(p,u,h,r,M,21,o[51]),r=C(r,p,u,h,P,6,o[52]),h=C(h,r,p,u,R,10,o[53]),u=C(u,h,r,p,N,15,o[54]),p=C(p,u,h,r,T,21,o[55]),r=C(r,p,u,h,l,6,o[56]),h=C(h,r,p,u,W,10,o[57]),u=C(u,h,r,p,H,15,o[58]),p=C(p,u,h,r,U,21,o[59]),r=C(r,p,u,h,L,6,o[60]),h=C(h,r,p,u,j,10,o[61]),u=C(u,h,r,p,E,15,o[62]),p=C(p,u,h,r,B,21,o[63]),f[0]=f[0]+r|0,f[1]=f[1]+p|0,f[2]=f[2]+u|0,f[3]=f[3]+h|0},_doFinalize:function(){var b=this._data,m=b.words,I=this._nDataBytes*8,s=b.sigBytes*8;m[s>>>5]|=128<<24-s%32;var d=t.floor(I/4294967296),f=I;m[(s+64>>>9<<4)+15]=(d<<8|d>>>24)&16711935|(d<<24|d>>>8)&4278255360,m[(s+64>>>9<<4)+14]=(f<<8|f>>>24)&16711935|(f<<24|f>>>8)&4278255360,b.sigBytes=(m.length+1)*4,this._process();for(var $=this._hash,T=$.words,E=0;E<4;E++){var R=T[E];T[E]=(R<<8|R>>>24)&16711935|(R<<24|R>>>8)&4278255360}return $},clone:function(){var b=v.clone.call(this);return b._hash=this._hash.clone(),b}});function g(b,m,I,s,d,f,$){var T=b+(m&I|~m&s)+d+$;return(T<<f|T>>>32-f)+m}function x(b,m,I,s,d,f,$){var T=b+(m&s|I&~s)+d+$;return(T<<f|T>>>32-f)+m}function D(b,m,I,s,d,f,$){var T=b+(m^I^s)+d+$;return(T<<f|T>>>32-f)+m}function C(b,m,I,s,d,f,$){var T=b+(I^(m|~s))+d+$;return(T<<f|T>>>32-f)+m}e.MD5=v._createHelper(S),e.HmacMD5=v._createHmacHelper(S)})(Math),i.MD5})})(z)),z.exports}var dt=ct();const ut=tt(dt);function pt(c,n){let i;return function(...e){const a=()=>{clearTimeout(i),c(...e)};clearTimeout(i),i=setTimeout(a,n)}}function ft(c,n=80){if(!c||!c.includes("commons.wikimedia.org"))return c;try{let i;c.includes("/wiki/File:")?i=c.split("/wiki/File:")[1]:(c.includes("/wikipedia/commons/"),i=c.split("/").pop()),i=decodeURIComponent(i),i=i.replace(/ /g,"_");const t=ut(i).toString(),e=t.charAt(0),a=t.substring(0,2);let k=`https://upload.wikimedia.org/wikipedia/commons/thumb/${e}/${a}/${encodeURIComponent(i)}/${n}px-${encodeURIComponent(i)}`;return k.endsWith(".tif")&&(k=k+".jpg"),k.endsWith(".svg")&&(k=k+".png"),k}catch(i){return console.error("Error converting to thumbnail:",i),c}}function Z(c){if(!c)return"";const n=c.split(/[,\s]+/).filter(i=>i.length>0);return n.length>=2?(n[1][0]+n[0][0]).toUpperCase():n[0][0].toUpperCase()}function q(c,n){const i=Array(n.length+1).fill(null).map(()=>Array(c.length+1).fill(null));for(let t=0;t<=c.length;t+=1)i[0][t]=t;for(let t=0;t<=n.length;t+=1)i[t][0]=t;for(let t=1;t<=n.length;t+=1)for(let e=1;e<=c.length;e+=1){const a=c[e-1]===n[t-1]?0:1;i[t][e]=Math.min(i[t][e-1]+1,i[t-1][e]+1,i[t-1][e-1]+a)}return i[n.length][c.length]}function J(){const c=document.getElementById("search-results");if(c)return c;const n=document.getElementById("search");if(!n)return console.error("Search input not found"),null;const i=n.closest(".field");if(!i)return console.error("Search container not found"),null;const t=document.createElement("div");return t.id="search-results",t.className="columns mt-4",i.parentNode.insertBefore(t,i.nextSibling),t}async function ht(c){if(!c.hits||c.hits.length===0)return'<p class="has-text-grey">No contributors found</p>';const n=[...c.hits].sort((t,e)=>{const a=t.contributions||0;return(e.contributions||0)-a}),i=await Promise.all(n.map(async t=>{let e=t.suggestLabel;if(t.token&&t.token.match(/^n\d+$/))try{const a=await fetch(`https://id.loc.gov/authorities/names/${t.token}.json`);if(a.ok){const v=(await a.json()).find(y=>y["@id"]===`http://id.loc.gov/authorities/names/${t.token}`&&y["@type"]&&(Array.isArray(y["@type"])?y["@type"].includes("http://www.loc.gov/mads/rdf/v1#Authority"):y["@type"]==="http://www.loc.gov/mads/rdf/v1#Authority"));if(v&&v["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"]){const y=v["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"];y&&y.length>0&&y[0]["@value"]&&(e=y[0]["@value"],console.log(`Found name for ${t.token}: ${e}`))}else console.log(`No authoritativeLabel found for ${t.token}`)}}catch(a){console.error(`Error fetching name for ${t.token}:`,a)}return{...t,displayName:e}}));return setTimeout(()=>gt(i),100),i.map(t=>{const e=Z(t.displayName);return`
      <div class="box p-2 mb-2 contributor-box" data-token="${t.token}" data-label="${t.displayName}" style="display: flex; align-items: stretch; min-height: 100px;">
        <div class="contributor-image mr-3" data-lccn="${t.token}">
          <div class="initials-circle" style="width: 80px; height: 100%; min-height: 96px; border-radius: 12px; background: linear-gradient(135deg, #85c1f5 0%, #276dcc 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.5rem;">
            ${e}
          </div>
        </div>
        <div style="flex: 1; padding: 0.5rem 0;">
          <p class="has-text-weight-semibold">${t.displayName}</p>
          ${t.contributions?`<p class="is-size-7 has-text-primary has-text-weight-semibold">${t.contributions} contributions</p>`:""}
          ${t.more?.birthdates&&t.more.birthdates[0]&&t.more.birthdates[0]!=="undefined"?`<p class="is-size-7 has-text-grey">Born: ${t.more.birthdates[0]}</p>`:""}
          ${t.more?.occupations&&t.more.occupations.length>0&&t.more.occupations[0]!=="undefined"?`<p class="is-size-7 has-text-grey">${t.more.occupations.filter(a=>a&&a!=="undefined").join(", ")}</p>`:""}
          <div class="wikidata-info" data-lccn="${t.token}"></div>
        </div>
      </div>
    `}).join("")}async function gt(c){const n=c.map(e=>e.token).filter(e=>e&&e.startsWith("n"));if(n.length===0)return;const i=`
    SELECT ?item ?itemLabel ?lccn ?image ?birthDate ?deathDate ?description WHERE {
      VALUES ?lccn { ${n.map(e=>`"${e}"`).join(" ")} }
      ?item wdt:P244 ?lccn .
      OPTIONAL { ?item wdt:P18 ?image }
      OPTIONAL { ?item wdt:P569 ?birthDate }
      OPTIONAL { ?item wdt:P570 ?deathDate }
      SERVICE wikibase:label {
        bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en" .
        ?item schema:description ?description .
        ?item rdfs:label ?itemLabel .
      }
    }
  `,t=`https://query.wikidata.org/sparql?query=${encodeURIComponent(i)}&format=json`;try{const e=await fetch(t,{headers:{Accept:"application/sparql-results+json"}});if(!e.ok){console.error("Wikidata query failed:",e.status);return}const a=await e.json();console.log("Wikidata results:",a),a.results&&a.results.bindings&&a.results.bindings.forEach(k=>{const v=k.lccn?.value,y=k.description?.value,o=k.item?.value,S=k.image?.value;if(S&&v){const x=document.querySelector(`.contributor-box[data-token="${v}"] .contributor-image`);if(x){const D=ft(S,80),C=document.querySelector(`.contributor-box[data-token="${v}"]`),b=C?C.dataset.label:"";x.innerHTML=`
              <img src="${D}" alt="Author photo" style="width: 80px; height: 100%; min-height: 96px; border-radius: 12px; object-fit: cover; opacity: 0;" onload="this.classList.add('loaded');" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
              <div class="initials-circle" style="width: 80px; height: 100%; min-height: 96px; border-radius: 12px; background: linear-gradient(135deg, #85c1f5 0%, #276dcc 100%); display: none; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.5rem;">
                ${Z(b)}
              </div>
            `}}const g=document.querySelector(`.contributor-box[data-token="${v}"] .wikidata-info`);g&&y&&y!=="undefined"&&(g.innerHTML=`
            <p class="is-size-7 has-text-dark mt-2">
              <strong>Wikidata:</strong> ${y}
            </p>
          `),console.log(`LCCN: ${v}, Description: ${y}, Image: ${S}, Wikidata: ${o}`)})}catch(e){console.error("Error fetching Wikidata:",e)}}function mt(c){return!c.hits||c.hits.length===0?'<p class="has-text-grey">No instances found</p>':c.hits.map(n=>{const i=n.uri,t=n.aLabel||"Unknown Instance";return`
      <div class="box p-3 mb-2 title-result" data-uri="${i}" style="cursor: pointer;" onclick="handleInstanceClick('${i}')">
        <p class="has-text-weight-semibold">${t}</p>
        ${n.suggestLabel?`<p class="is-size-7 has-text-grey">${n.suggestLabel}</p>`:""}
      </div>
    `}).join("")}function bt(c,n){if(!c.hits||c.hits.length===0)return'<p class="has-text-grey">No titles found</p>';let i=c.hits.filter(e=>!window.excludedUris||!window.excludedUris.has(e.uri));if(i.length===0)return'<p class="has-text-grey">No titles found</p>';const t=i.map(e=>{const a=e.more?.contributors&&e.more.contributors[0],k=a&&e.aLabel&&e.aLabel.includes(a);let v=e.aLabel||e.suggestLabel||"";e.more?.contributors&&e.more.contributors.forEach(g=>{v=v.replace(g,"").replace(/^\.\s*/,"").trim()});let y=n?q(n.toLowerCase(),v.toLowerCase()):999999;k&&a&&n&&(a.toLowerCase().includes(n.toLowerCase())?y=Math.max(0,y-25):y=Math.max(0,y-8));const o=e.more?.languages&&e.more.languages.some(g=>g==="English"||g==="mlang:eng"||g.toLowerCase().includes("eng")),S=e.token?parseInt(e.token):999999999;return{...e,distance:y,originalDistance:n?q(n.toLowerCase(),v.toLowerCase()):999999,labelWithoutContributors:v,hasContributorInLabel:k,isEnglish:o,tokenNum:S}});return t.sort((e,a)=>e.distance!==a.distance?e.distance-a.distance:e.hasContributorInLabel!==a.hasContributorInLabel?e.hasContributorInLabel?-1:1:e.isEnglish!==a.isEnglish?a.isEnglish?1:-1:e.tokenNum-a.tokenNum),t.map(e=>`
    <div class="box p-3 mb-2 title-result" data-uri="${e.uri}" style="cursor: pointer;">
      <p class="has-text-weight-semibold">${e.suggestLabel}</p>
      ${e.vLabel&&e.vLabel!==e.aLabel?`<p class="is-size-6 has-text-dark">${e.vLabel}</p>`:""}
      ${e.more?.contributors&&e.more.contributors.length>1?`<p class="is-size-7 has-text-grey">Contributors: ${e.more.contributors.slice(1).join(", ")}</p>`:""}
      ${e.more?.languages?`<p class="is-size-7 has-text-grey">Language: ${e.more.languages.join(", ")}</p>`:""}
    </div>
  `).join("")}let O=null,A={type:null,data:null};window.performSearches=async function(n){if(A={type:"search",data:{query:n}},O&&(O.abort(),O=null),!n||n.length<2){const e=document.getElementById("search-results");e&&(e.innerHTML="");return}O=new AbortController;const i=O.signal,t=J();if(!t){console.error("Could not create results container");return}t.innerHTML='<div class="column"><p>Searching...</p></div>';try{if(/^\d+$/.test(n.trim())){const a=`https://id.loc.gov/resources/instances/suggest2/?q=${encodeURIComponent(n)}&searchtype=keyword`,v=await(await fetch(a,{signal:i})).json();t.innerHTML=`
        <div class="column">
          <h4 class="title is-5 mb-3">Instance Search Results for "${n}"</h4>
          <div class="instance-results">
            ${mt(v)}
          </div>
        </div>
      `}else{const a=`https://id.loc.gov/authorities/names/suggest2/?q=${encodeURIComponent(n)}*&searchtype=keyword&rdftype=PersonalName&usage=true&count=20`,k=`https://id.loc.gov/resources/works/suggest2/?q=${encodeURIComponent(n)}&searchtype=keyword&rdftype=Monograph&rdftype=Text&count=100`,[v,y]=await Promise.all([fetch(a,{signal:i}),fetch(k,{signal:i})]),[o,S]=await Promise.all([v.json(),y.json()]),g=await ht(o);t.innerHTML=`
        <div class="column is-4">
          <h4 class="title is-5 mb-3">Contributors - Click to Load</h4>
          <div class="contributor-results">
            ${g}
          </div>
        </div>
        <div class="column is-8">
          <h4 class="title is-5 mb-3">Titles - results for "<i>${n}</i>"</h4>
          <div class="title-results">
            ${bt(S,n)}
          </div>
        </div>
      `}}catch(e){if(e.name==="AbortError"){console.log("Search cancelled due to new input");return}t.innerHTML=`
      <div class="column">
        <div class="notification is-danger">
          Error performing search: ${e.message}
        </div>
      </div>
    `}finally{O?.signal===i&&(O=null)}};async function X(c,n=!0){c.forEach(async i=>{const t=i.uri.split("/").pop(),e=`https://id.loc.gov/resources/instances/${t}.bibframe_raw.json`;try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const v=(await a.json()).find(g=>g["@id"]===`http://id.loc.gov/resources/instances/${t}`);let y="",o="";if(v){if(v["http://id.loc.gov/ontologies/bibframe/publicationStatement"]){y=v["http://id.loc.gov/ontologies/bibframe/publicationStatement"][0]?.["@value"]||"";const g=y.match(/\b(c?)(1[5-9]\d{2}|20[0-2]\d)\b/g);if(g&&g.length>0){const D=g.map(C=>{const b=C.startsWith("c"),m=parseInt(C.replace("c",""));return{original:C,numeric:m,hasC:b}}).reduce((C,b)=>b.numeric>C.numeric?b:C);y=y.replace(new RegExp(`\\b${D.original}\\b`,"g"),`<strong>${D.original}</strong>`)}}v["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"]&&(o=v["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"][0]?.["@value"]||"")}const S=document.querySelector(`.instance-details[data-work-id="${t}"]`);S&&(y||o?S.innerHTML=`
            ${o?`<p class="is-size-7 has-text-grey">By: ${o}</p>`:""}
            ${y&&n?`<p class="is-size-7 has-text-grey"><strong>Published:</strong> ${y}</p>`:""}
          `:S.innerHTML='<p class="is-size-7 has-text-grey-light">No instance details available</p>')}catch(a){console.error(`Error fetching instance for work ${t}:`,a);const k=document.querySelector(`.instance-details[data-work-id="${t}"]`);k&&(k.innerHTML='<p class="is-size-7 has-text-grey-light">Details not available</p>')}})}async function Q(c,n){const i=document.getElementById("search-results");i&&i.scrollIntoView({behavior:"smooth",block:"start"}),console.log(`[CONTRIBUTOR] Processing works for: ${n} (${c})`);const t=document.querySelector("#search-results .column:last-child .title-results"),e=document.querySelector("#search-results .column:last-child h4");document.querySelector("#search-results .column:last-child");const a=document.getElementById("search");a&&a.value,t&&(t.innerHTML=`
      <div class="progress-container">
        <div class="progress">
          <div class="progress-bar" style="width: 0%"></div>
        </div>
        <div class="progress-text">Loading contributor works...</div>
      </div>
    `);const k=(y,o)=>{const S=t?.querySelector(".progress-bar"),g=t?.querySelector(".progress-text");S&&(S.style.width=`${y}%`),g&&(g.textContent=o)};e&&(e.innerHTML=`
      <span style="display: flex; align-items: center; justify-content: space-between;">
        <span>Titles - Please Select Work</span>
        <button class="button is-small is-light" onclick="(() => { const input = document.getElementById('search'); if (input && input.value) { performSearches(input.value); } })()">
          <span>← Back</span>
        </button>
      </span>
    `);try{let f=function(w){return w.toLowerCase().replace(/[.,;:!?\-–—'"'""\[\](){}]/g,"").replace(/\s+/g," ").trim()};var v=f;k(5,"Fetching contributor information...");const y=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${c}&page=0`,S=await(await fetch(y)).json(),g=Math.min(S.summary.totalPages,49);k(10,`Found ${S.summary.totalPages+1} pages of works...`);const x=[];for(let w=0;w<=g;w++){const l=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${c}&page=${w}`;x.push(fetch(l).then(B=>B.json()))}k(15,`Loading ${g+1} pages of works...`);const D=await Promise.all(x);k(30,"Processing work records...");const C=D.flatMap(w=>w.results||[]),b=new Map;C.forEach(w=>{b.has(w.uri)||b.set(w.uri,w)});const m=Array.from(b.values());console.log(`Total results before dedup: ${C.length}, after dedup: ${m.length}`),console.log(`Checking types for ${m.length} works...`),k(35,`Fetching details for ${m.length} works...`);let I=0;const s=m.map(async w=>{const l=w.uri.split("/").pop();try{const N=await(await fetch(`https://id.loc.gov/resources/works/${l}.bibframe_raw.json`)).json();I++;const j=35+Math.round(I/m.length*55);k(j,`Loading work details... (${I}/${m.length})`);const P=N.find(r=>r["@id"]===w.uri);let U=!1,_=!1,W=null;if(P)if(console.log(`Work ${l}:`,P["@type"]),P["@type"]&&Array.isArray(P["@type"])){if(U=P["@type"].includes("http://id.loc.gov/ontologies/bibframe/Text"),_=!U&&P["@type"].length>1,_){const r=P["@type"].find(p=>{const u=p.split("/").pop();return u!=="Work"&&u!=="Monograph"&&u!=="Text"});r&&(W=r.split("/").pop())}console.log(`  Has Text type: ${U}, Is Non-Text: ${_}, Work Type: ${W}`)}else console.log("  No @type field found");else console.log(`  Main work not found for ${w.uri}`);return{...w,isText:U,isNonText:_,workType:W,bibframeData:N}}catch(B){return console.error(`  Error fetching ${l}:`,B),{...w,isText:!0,isNonText:!1,workType:null,bibframeData:null}}}),d=await Promise.all(s);k(95,"Organizing results..."),window.contributorWorksBibframeData={},d.forEach(w=>{window.contributorWorksBibframeData[w.uri]=w.bibframeData});const $={},T={},E={};let R=0;d.forEach(w=>{let l=w.label;const B=w.uri.split("/").pop();if(console.log(`[TITLE DEBUG ${B}] Starting title extraction`),console.log(`[TITLE DEBUG ${B}] Initial label from API:`,w.label),console.log(`[TITLE DEBUG ${B}] Known contributor:`,n),l)console.log(`[TITLE DEBUG ${B}] ✓ Using label from API: "${l}"`);else if(console.log(`[TITLE DEBUG ${B}] No label from API, checking bibframe data`),w.bibframeData){console.log(`[TITLE DEBUG ${B}] Bibframe data exists, searching for work object`);const U=w.bibframeData.find(_=>_["@id"]===w.uri);if(U){console.log(`[TITLE DEBUG ${B}] Found main work object`);const _=U["http://id.loc.gov/ontologies/bflc/aap"];if(_&&_[0])l=_[0]["@value"],console.log(`[TITLE DEBUG ${B}] ✓ Using AAP: "${l}"`);else{console.log(`[TITLE DEBUG ${B}] No AAP found, trying title property`);const W=U["http://id.loc.gov/ontologies/bibframe/title"];if(W&&W[0]){const r=W[0]["@id"];console.log(`[TITLE DEBUG ${B}] Found title reference: ${r}`);const p=w.bibframeData.find(u=>u["@id"]===r);if(p){console.log(`[TITLE DEBUG ${B}] Found title object`);const u=p["http://id.loc.gov/ontologies/bibframe/mainTitle"];u&&u[0]?(l=u[0]["@value"],console.log(`[TITLE DEBUG ${B}] ✓ Using mainTitle: "${l}"`)):console.log(`[TITLE DEBUG ${B}] No mainTitle in title object`)}else console.log(`[TITLE DEBUG ${B}] Could not find title object with ID: ${r}`)}else console.log(`[TITLE DEBUG ${B}] No title property in main work`)}}else console.log(`[TITLE DEBUG ${B}] Could not find main work object in bibframe data`)}else console.log(`[TITLE DEBUG ${B}] No bibframe data available`);l?console.log(`[TITLE DEBUG ${B}] Final title before processing: "${l}"`):(console.warn(`[TITLE DEBUG ${B}] ⚠️ No title found anywhere, using ID fallback`),l=`Work ${B}`);const N=l;let j=!1;if(n&&l.startsWith(n)){let U=l.substring(n.length);U=U.replace(/^[\s.,:\-–—]+/,""),U&&U.length>0&&(l=U.trim(),console.log(`[TITLE DEBUG] Used known contributor name to extract: "${l}"`),j=!0)}else if(n){const U=n.split(",")[0].trim();if(l.startsWith(U)){const _=[new RegExp(`^${U.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}[^.]*\\.s+`),new RegExp(`^${U.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}[^.]*[-–]s+`)];for(const W of _){const r=l.match(W);if(r){l=l.substring(r[0].length),console.log(`[TITLE DEBUG] Used partial contributor match to extract: "${l}"`),j=!0;break}}}}if(!j&&l.match(/^[^,]+,\s*[^,\.]+/)){const U=l.match(/^[^,]+,\s*[^,]+(?:,\s*(?:Sir|Dr|Prof|Mr|Mrs|Ms|Miss|Lord|Lady|Baron|Count|Duke)[^,]*)?(?:,\s*\d{4}[-–](?:\d{4})?)?\s*\.\s+/);if(U)l=l.substring(U[0].length),console.log(`[TITLE DEBUG] Matched author with title/honorific pattern, extracted: "${l}"`),j=!0;else{const _=l.match(/^[^,]+,\s*[^,]+,\s*\d{4}[-–](?:\d{4})?\s*[-.]?\s*/);if(_)l=l.substring(_[0].length),console.log(`[TITLE DEBUG] Matched author with dates pattern, extracted: "${l}"`),j=!0;else{const W=l.match(/^[^,]+,\s*(?:[A-Z]\.?\s*)+(?:[A-Za-z]+\s*)?(?:\([^)]+\))?\s*\.\s+([A-Z])/);if(W){const r=l.indexOf(W[1],W.index);l=l.substring(r),console.log(`[TITLE DEBUG] Matched name with initials, extracted: "${l}"`),j=!0}else{const r=l.match(/^[^,]+,\s*[^.]+\.\s+/);r&&(l=l.substring(r[0].length),console.log(`[TITLE DEBUG] Matched last period pattern, extracted: "${l}"`),j=!0)}}}if(!j){if(l&&l.match(/^[^,]+,\s*[^,\.]+/)){const _=l.match(/\d{4}[-–]\d{0,4}\s+/),W=l.match(/\d{4}[-–]\s+/);_?l=l.substring(_.index+_[0].length):W&&(l=l.substring(W.index+W[0].length))}if((!l||l.match(/^[^,]+,\s*[^,\.]+/))&&(N.match(/,/g)||[]).length>=1){const W=N.indexOf(","),p=N.substring(W+1).trim().search(/[\s,]/);if(p>-1){const u=W+1+p+1,h=N.substring(u).trim();h&&!h.match(/^[^,]+,\s*[^,]+/)&&(l=h,console.log(`[TITLE DEBUG] Used fallback pattern, extracted: "${l}"`))}}}}const P=f(l);E[P]||(E[P]={}),E[P][l]||(E[P][l]=0),E[P][l]++,w.isNonText&&(R++,console.log(`Non-text work found: ${l}`)),w.displayTitle=l,w.normalizedTitle=P,console.log(`[TITLE DEBUG ${B}] After processing:`),console.log(`[TITLE DEBUG ${B}]   Display title: "${w.displayTitle}"`),console.log(`[TITLE DEBUG ${B}]   Normalized: "${w.normalizedTitle}"`)});const L=new Set;d.forEach(w=>{if(L.has(w.uri)){console.log(`Skipping duplicate URI: ${w.uri}`);return}L.add(w.uri);const l=w.normalizedTitle,B=w.isNonText?T:$;let N=w.displayTitle;if(E[l]){let j=0;Object.entries(E[l]).forEach(([P,U])=>{U>j&&(j=U,N=P)})}B[l]||(B[l]={displayTitle:N,works:[]}),B[l].works.push(w)}),console.log(`Total works: ${d.length}, Non-text works: ${R}`);const M=Object.keys($).sort((w,l)=>$[w].displayTitle.localeCompare($[l].displayTitle)),H=Object.keys(T).sort((w,l)=>T[w].displayTitle.localeCompare(T[l].displayTitle));if(console.log(`Text titles: ${M.length}, Non-text titles: ${H.length}`),t)if(M.length===0&&H.length===0)t.innerHTML='<p class="has-text-grey">No works found</p>';else{let w="";const l=M.filter(j=>$[j].works.length>1),B=M.filter(j=>$[j].works.length===1);l.length>0&&(w+='<p class="has-text-primary has-text-weight-semibold mb-3">Multiple Instances</p>',w+=l.map(j=>{const P=$[j],U=P.works,_=P.displayTitle,W=U[0],r=U.map(p=>p.uri).join(",");return(!_||_.trim()==="")&&(console.error(`[TITLE DEBUG] EMPTY TITLE for group with key "${j}"`),console.error("[TITLE DEBUG] Works in group:",U),console.error("[TITLE DEBUG] Group data:",P)),`
              <div class="box p-3 mb-2 collapsed-work-result" data-uri="${W.uri}" data-all-uris="${r}" data-title="${_.replace(/"/g,"&quot;")}" style="cursor: pointer;">
                <p class="has-text-weight-semibold">${_}</p>
                <p class="is-size-7 has-text-grey">${U.length} instances</p>
                <div class="instance-details" data-work-id="${W.uri.split("/").pop()}">
                  <p class="is-size-7 has-text-grey-light">Loading details...</p>
                </div>
              </div>
            `}).join("")),B.length>0&&(l.length>0&&(w+='<hr style="margin: 1.5rem 0;">'),w+='<p class="has-text-primary has-text-weight-semibold mb-3">Single Instance</p>',w+=B.map(j=>{const P=$[j],U=P.works,_=P.displayTitle,W=U[0];return`
              <div class="box p-3 mb-2 title-result single-instance" data-uri="${W.uri}" style="cursor: pointer;">
                <p class="has-text-weight-semibold">${_}</p>
                <div class="instance-details" data-work-id="${W.uri.split("/").pop()}">
                  <p class="is-size-7 has-text-grey-light">Loading details...</p>
                </div>
              </div>
            `}).join("")),H.length>0&&(w+=`
            <hr style="margin: 1.5rem 0;">
            <p class="has-text-grey has-text-weight-semibold mb-3">Non-Text Works</p>
          `,w+=H.map(j=>{const P=T[j],U=P.works,_=P.displayTitle,W=U[0],r=U.map(u=>u.uri).join(","),p=W.workType;return`
              <div class="box p-3 mb-2 non-text-work ${U.length>1?"collapsed-work-result":"title-result single-instance"}" data-uri="${W.uri}" ${U.length>1?`data-all-uris="${r}" data-title="${_.replace(/"/g,"&quot;")}"`:""} style="cursor: pointer;">
                <p class="has-text-weight-semibold">
                  ${_}
                  ${p?`<span class="is-size-7 has-text-grey-light ml-2">[${p}]</span>`:""}
                </p>
                ${U.length>1?`<p class="is-size-7 has-text-grey">${U.length} instances</p>`:""}
                <div class="instance-details" data-work-id="${W.uri.split("/").pop()}">
                  <p class="is-size-7 has-text-grey-light">Loading details...</p>
                </div>
              </div>
            `}).join("")),t.innerHTML=w;const N=[...l.map(j=>$[j].works[0]),...B.map(j=>$[j].works[0]),...H.map(j=>T[j].works[0])];X(N,!1)}}catch(y){console.error("Error fetching contributor works:",y),t&&(t.innerHTML='<p class="has-text-danger">Error loading contributor works</p>')}}window.handleCollapsedWorkClick=async function(n,i){console.log("[handleCollapsedWorkClick] Called with:",{allUris:n,title:i}),A={type:"all-instances",data:{allUris:n,title:i}},console.log("[handleCollapsedWorkClick] Set navigation context:",A);let t=document.getElementById("search-results");console.log("[handleCollapsedWorkClick] Results container exists?",!!t);const e=t&&t.querySelector(".contributor-results")&&t.querySelector(".title-results");t&&(console.log("[handleCollapsedWorkClick] Results container HTML:",t.innerHTML.substring(0,200)),console.log("[handleCollapsedWorkClick] Has search structure?",e)),!t||!e?(console.log("[handleCollapsedWorkClick] Recreating search results structure"),t||(t=J()),t.innerHTML=`
      <div class="columns">
        <div class="column is-4">
          <h4 class="title is-5 mb-3">Contributors</h4>
          <div class="contributor-results">
            <p class="has-text-grey">Search to see contributors</p>
          </div>
        </div>
        <div class="column is-8">
          <h4 class="title is-5 mb-3">Titles - Please Select Instance</h4>
          <div class="title-results">
            <div class="working-message">Loading all instances...</div>
          </div>
        </div>
      </div>
    `):console.log("[handleCollapsedWorkClick] Using existing search results structure"),t&&t.scrollIntoView({behavior:"smooth",block:"start"});const a=document.querySelector("#search-results .column:last-child .title-results"),k=document.querySelector("#search-results .column:last-child h4");if(console.log("[handleCollapsedWorkClick] Title column found?",!!a),console.log("[handleCollapsedWorkClick] Title header found?",!!k),a?(console.log("[handleCollapsedWorkClick] Setting loading state"),a.innerHTML='<div class="working-message">Loading all instances...</div>'):console.error("[handleCollapsedWorkClick] Could not find title column!"),k){k.innerHTML=`
      <span style="display: flex; align-items: center; justify-content: space-between;">
        <span>Titles - Please Select Instance</span>
        <button class="button is-small is-light" id="back-to-works">
          <span>← Back</span>
        </button>
      </span>
    `;const v=document.getElementById("back-to-works");v&&v.addEventListener("click",()=>{const y=document.querySelector('.contributor-box[data-selected="true"]');if(y){const o=y.dataset.token,S=y.dataset.label;o&&o.startsWith("n")&&Q(o,S)}else{const o=document.getElementById("search");o&&o.value&&performSearches(o.value)}})}console.log("[handleCollapsedWorkClick] Starting to fetch instances");try{const v=n.split(",");console.log("[handleCollapsedWorkClick] Processing",v.length,"URIs");const y=v.map(async S=>{const g=S.split("/").pop(),x=S.replace("/resources/works/","/resources/instances/"),D=`https://id.loc.gov/resources/instances/${g}.bibframe_raw.json`;try{const C=await fetch(D);if(!C.ok)return{"@id":x,label:`Instance ${g}`,workId:g};const b=await C.json(),m=b.find(s=>s["@id"]===x);let I=`Instance ${g}`;if(m){if(m["http://www.w3.org/2000/01/rdf-schema#label"])I=m["http://www.w3.org/2000/01/rdf-schema#label"][0]["@value"];else if(m["http://id.loc.gov/ontologies/bibframe/title"]){const s=m["http://id.loc.gov/ontologies/bibframe/title"][0]["@id"],d=b.find(f=>f["@id"]===s);d&&d["http://id.loc.gov/ontologies/bibframe/mainTitle"]&&(I=d["http://id.loc.gov/ontologies/bibframe/mainTitle"][0]["@value"])}}return{"@id":x,label:I,workId:g,data:m}}catch(C){return console.error(`Error fetching instance ${g}:`,C),{"@id":x,label:`Instance ${g}`,workId:g}}}),o=await Promise.all(y);if(a)if(o.length===0)a.innerHTML='<p class="has-text-grey">No instances found</p>';else{let S=`<p class="has-text-primary has-text-weight-semibold mb-3">${i} - All Instances</p>`;o.sort((g,x)=>{const D=parseInt(g["@id"].split("/").pop())||0,C=parseInt(x["@id"].split("/").pop())||0;return D-C}),S+=o.map(g=>{const x=g["@id"],D=g.label,C=g.workId;let b="",m="";if(g.data){if(g.data["http://id.loc.gov/ontologies/bibframe/publicationStatement"]){b=g.data["http://id.loc.gov/ontologies/bibframe/publicationStatement"][0]?.["@value"]||"";const I=b.match(/\b(c?)(1[5-9]\d{2}|20[0-2]\d)\b/g);if(I&&I.length>0){const d=I.map(f=>{const $=f.startsWith("c"),T=parseInt(f.replace("c",""));return{original:f,numeric:T,hasC:$}}).reduce((f,$)=>$.numeric>f.numeric?$:f);b=b.replace(new RegExp(`\\b${d.original}\\b`,"g"),`<strong>${d.original}</strong>`)}}g.data["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"]&&(m=g.data["http://id.loc.gov/ontologies/bibframe/responsibilityStatement"][0]?.["@value"]||"")}return`
            <div class="box p-3 mb-2 title-result" data-uri="${x}" style="cursor: pointer;">
              <p class="has-text-weight-semibold">${D}</p>
              <div class="instance-details">
                ${m?`<p class="is-size-7 has-text-grey">By: ${m}</p>`:""}
                ${b?`<p class="is-size-7 has-text-grey"><strong>Published:</strong> ${b}</p>`:""}
                ${!m&&!b?'<p class="is-size-7 has-text-grey-light">No additional details available</p>':""}
              </div>
            </div>
          `}).join(""),a.innerHTML=S}console.log("[handleCollapsedWorkClick] Completed successfully")}catch(v){console.error("[handleCollapsedWorkClick] Error:",v),console.error("[handleCollapsedWorkClick] Error stack:",v.stack);const y=document.querySelector("#search-results .column:last-child .title-results");y&&(y.innerHTML='<p class="has-text-danger">Error loading instances</p>')}};async function vt(c,n){const i=document.getElementById("search-results");i&&i.scrollIntoView({behavior:"smooth",block:"start"});const t=c.split("/").pop(),e=`https://id.loc.gov/resources/works/${t}.bibframe_raw.json`,a=document.getElementById("search"),k=a?a.value.toLowerCase():"";try{const y=await(await fetch(e)).json(),o=y.find(S=>S["@id"]===c);if(o&&o["http://id.loc.gov/ontologies/bibframe/contribution"]){const S=o["http://id.loc.gov/ontologies/bibframe/contribution"][0]["@id"],g=y.find(x=>x["@id"]===S);if(g&&g["http://id.loc.gov/ontologies/bibframe/agent"]){let x=g["http://id.loc.gov/ontologies/bibframe/agent"][0]["@id"];if(x.startsWith("_:")){const L=`https://id.loc.gov/resources/works/${t}.bibframe.json`;try{const H=await(await fetch(L)).json(),w=H.find(l=>l["@id"]===c);if(w&&w["http://id.loc.gov/ontologies/bibframe/contribution"]){const l=w["http://id.loc.gov/ontologies/bibframe/contribution"][0]["@id"],B=H.find(N=>N["@id"]===l);B&&B["http://id.loc.gov/ontologies/bibframe/agent"]&&(x=B["http://id.loc.gov/ontologies/bibframe/agent"][0]["@id"])}}catch(M){console.error("Error fetching processed bibframe data:",M)}}if(x.startsWith("_:"))throw new Error("Unable to resolve contributor - blank node found");const D=x.split("/").pop(),C=document.querySelector("#search-results .column:last-child .title-results"),b=document.querySelector("#search-results .column:last-child");C&&b&&(b.classList.add("slide-transition"),C.innerHTML='<div class="working-message">Working...</div>',setTimeout(()=>{b.classList.remove("slide-transition")},400));const m=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${D}&page=0`,s=await(await fetch(m)).json(),d=Math.min(s.summary.totalPages,29),f=[];for(let L=0;L<=d;L++){const M=`https://id.loc.gov/resources/works/relationships/contributorto/?label=http://id.loc.gov/authorities/names/${D}&page=${L}`;f.push(fetch(M).then(H=>H.json()))}const R=(await Promise.all(f)).flatMap(L=>L.results||[]).map(L=>{const M=L.label.toLowerCase(),H=k?q(k,M):1/0,w=n?q(n.toLowerCase(),M):1/0,l=Math.min(H,w);return{...L,distance:l}}).sort((L,M)=>L.distance-M.distance).slice(0,20);if(C)if(R.length===0)C.innerHTML='<p class="has-text-grey">No matching works found</p>';else{const L=document.querySelector("#search-results .column:last-child h4");L&&(L.innerHTML=`
                <span style="display: flex; align-items: center; justify-content: space-between;">
                  <span>Titles - Please Select Instance</span>
                  <button class="button is-small is-light" onclick="(() => { const input = document.getElementById('search'); if (input && input.value) { performSearches(input.value); } })()">
                    <span>← Back</span>
                  </button>
                </span>
              `);const M=R.filter(l=>l.distance<=5),H=R.filter(l=>l.distance>5);M.sort((l,B)=>{const N=parseInt(l.uri.split("/").pop())||0,j=parseInt(B.uri.split("/").pop())||0;return N-j});let w="";M.length>0&&(w+=M.map(l=>`
                <div class="box p-3 mb-2 title-result instance-selection" data-uri="${l.uri}" style="cursor: pointer;">
                  <p class="has-text-weight-semibold">${l.label}</p>
                  <div class="instance-details" data-work-id="${l.uri.split("/").pop()}">
                    <p class="is-size-7 has-text-grey-light">Loading details...</p>
                  </div>
                </div>
              `).join("")),H.length>0&&(w+=`
                <hr style="margin: 1.5rem 0;">
                <p class="has-text-grey has-text-weight-semibold mb-3">Poor Matches</p>
              `,w+=H.map(l=>`
                <div class="box p-3 mb-2 title-result instance-selection" data-uri="${l.uri}" style="cursor: pointer;">
                  <p class="has-text-weight-semibold">${l.label}</p>
                  <div class="instance-details" data-work-id="${l.uri.split("/").pop()}">
                    <p class="is-size-7 has-text-grey-light">Loading details...</p>
                  </div>
                </div>
              `).join("")),C.innerHTML=w,X(R)}}}}catch(v){console.error("Error fetching bibframe data:",v);const y=document.querySelector("#search-results .column:last-child .title-results");y&&(y.innerHTML='<p class="has-text-danger">Error loading related works</p>',window.excludedUris||(window.excludedUris=new Set),window.excludedUris.add(c),setTimeout(()=>{const o=document.getElementById("search");o&&o.value&&performSearches(o.value)},1e3))}}async function Y(c){console.log("[handleInstanceClick] Called with:",c),console.log("[handleInstanceClick] Current navigation context:",A);const n=document.getElementById("search");if(n){const k=n.closest(".field").parentElement;k&&k.scrollIntoView({behavior:"smooth",block:"start"})}const i=c.split("/").pop(),t=c.replace("/instances/","/works/"),e=t.split("/").pop(),a=document.getElementById("search-results");a.innerHTML=`
    <div class="columns">
      <div class="column is-8">
        <div class="shimmer-container">
          <div class="shimmer shimmer-title"></div>
          <div class="box">
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line medium"></div>
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line short"></div>
            <br>
            <div class="shimmer shimmer-line medium"></div>
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line medium"></div>
            <br>
            <div class="shimmer shimmer-line long"></div>
            <div class="shimmer shimmer-line short"></div>
            <div class="shimmer shimmer-line medium"></div>
          </div>
        </div>
      </div>
      <div class="column is-4">
        <div class="shimmer-container">
          <div class="shimmer shimmer-button"></div>
          <div class="shimmer shimmer-button"></div>
          <br><br>
          <div class="shimmer shimmer-box"></div>
        </div>
      </div>
    </div>
  `;try{const[k,v]=await Promise.all([fetch(`https://id.loc.gov/resources/works/${e}.bibframe.json`),fetch(`https://id.loc.gov/resources/instances/${i}.bibframe.json`)]),y=await k.json(),o=await v.json(),S=await yt(y,o,t,c);a.innerHTML=`
      <div class="columns">
        <div class="column is-8">
          <h3 class="title is-4 mb-4">Instance Details</h3>
          <div class="box">
            ${wt(S)}
          </div>
        </div>
        <div class="column is-4">
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button class="button is-small is-light" id="back-button-instance">
              <span>${A.type==="all-instances"?"← Back to All Instances":"← Back to Search"}</span>
            </button>
            <button class="button is-primary" onclick="window.open('https://bibframe.org/marva/quartz/?action=load&url=https://id.loc.gov/resources/instances/${i}.cbd.rdf&profile=lc:RT:bf2:Monograph:Instance', '_blank')">
              Open in Marva Editor
            </button>
            <button class="button is-info" onclick="window.open('${t}', '_blank')">
              View on id.loc.gov
            </button>
          </div>
          <div style="margin-top:2em;"><a href="https://www.loc.gov/catworkshop/bibframe/Library-of-Congress-Marva-Quartz-User-Manual.pdf" target="_blank">View Marva Manual</a></div>
        </div>
      </div>
    `;const g=document.getElementById("back-button-instance");g?g.addEventListener("click",()=>{if(console.log("[BACK BUTTON] Navigation context:",A),A.type==="all-instances"){console.log("[BACK BUTTON] Going back to all instances"),console.log("[BACK BUTTON] URIs:",A.data.allUris),console.log("[BACK BUTTON] Title:",A.data.title);try{window.handleCollapsedWorkClick(A.data.allUris,A.data.title)}catch(x){console.error("[BACK BUTTON] Error calling handleCollapsedWorkClick:",x)}}else{console.log("[BACK BUTTON] Going back to search");const x=document.getElementById("search");x&&x.value&&performSearches(x.value)}}):console.error("[BACK BUTTON] Could not find back button element")}catch(k){console.error("Error loading instance details:",k),a.innerHTML=`
      <div class="notification is-danger">
        Error loading instance details. Please try again.
        <button class="button is-small is-light mt-3" id="error-back-button">
          <span>${A.type==="all-instances"?"← Back to All Instances":"← Back to Search"}</span>
        </button>
      </div>
    `;const v=document.getElementById("error-back-button");v&&v.addEventListener("click",()=>{if(A.type==="all-instances")window.handleCollapsedWorkClick(A.data.allUris,A.data.title);else{const y=document.getElementById("search");y&&y.value&&performSearches(y.value)}})}}async function yt(c,n,i,t){const e={title:"",contributors:[],publicationStatement:"",extent:"",isbn:[],language:[],subjects:[],notes:[],workUri:i,instanceUri:t},a=c.find(v=>v["@id"]===i)||c[0],k=n.find(v=>v["@id"]===t)||n[0];if(a){const v=a["http://id.loc.gov/ontologies/bibframe/title"];if(v&&v[0]){const b=v[0]["@id"],m=c.find(I=>I["@id"]===b);if(m){const I=m["http://id.loc.gov/ontologies/bibframe/mainTitle"],s=m["http://id.loc.gov/ontologies/bibframe/subtitle"];e.title=I?I[0]["@value"]:"",s&&(e.title+=": "+s[0]["@value"])}}const o=(a["http://id.loc.gov/ontologies/bibframe/contribution"]||[]).map(async b=>{const m=b["@id"],I=c.find(s=>s["@id"]===m);if(I){const s=I["http://id.loc.gov/ontologies/bibframe/agent"];if(s&&s[0]){const d=s[0]["@id"];if(d.startsWith("_:")){const f=c.find($=>$["@id"]===d);if(f){const $=f["http://www.w3.org/2000/01/rdf-schema#label"];if($&&$[0])return{name:$[0]["@value"],uri:null}}}else{const f=d.split("/").pop();try{console.log(`Fetching contributor data for LCCN: ${f}, URI: ${d}`);const $=await fetch(`https://id.loc.gov/authorities/names/${f}.json`);if($.ok){const T=await $.json();console.log(`Received data for ${f}, array length: ${T.length}`);const E=`http://id.loc.gov/authorities/names/${f}`,R=T.find(L=>(L["@id"]===d||L["@id"]===E)&&L["@type"]&&(Array.isArray(L["@type"])?L["@type"].includes("http://www.loc.gov/mads/rdf/v1#Authority"):L["@type"]==="http://www.loc.gov/mads/rdf/v1#Authority"));if(console.log(`Found agent for ${f}:`,R?"Yes":"No"),console.log(`Looking for URI: ${d} or ${E}`),R&&R["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"]){const L=R["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"];if(console.log(`Found authoritativeLabel for ${f}:`,L),L&&L.length>0&&L[0]["@value"]){const M=L[0]["@value"];return console.log(`Returning name for ${f}: ${M}`),{name:M,uri:d}}}else console.log(`No agent or authoritativeLabel found for ${f}`)}else console.log(`Failed to fetch data for ${f}, status: ${$.status}`)}catch($){console.error(`Error fetching contributor ${f}:`,$)}return console.log(`Using fallback LCCN for ${f}`),{name:f,uri:d}}}}return null}),S=await Promise.all(o);e.contributors=S.filter(b=>b!==null),(a["http://id.loc.gov/ontologies/bibframe/language"]||[]).forEach(b=>{const m=b["@id"];m&&e.language.push(m.split("/").pop())});const D=(a["http://id.loc.gov/ontologies/bibframe/subject"]||[]).map(async b=>{const m=b["@id"];if(m)if(m.startsWith("_:")){const I=c.find(s=>s["@id"]===m);if(I){const s=I["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"],d=I["http://www.w3.org/2000/01/rdf-schema#label"];if(s&&s[0])return{label:s[0]["@value"],uri:null};if(d&&d[0])return{label:d[0]["@value"],uri:null}}return null}else{const I=m.split("/").pop(),s=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(I),d=s?`https://id.loc.gov/resources/hubs/${I}.json`:`https://id.loc.gov/authorities/subjects/${I}.json`;try{const f=await fetch(d);if(f.ok){const T=(await f.json()).find(E=>E["@id"]===m);if(T)if(s){const E=T["http://id.loc.gov/ontologies/bflc/aap"];if(E&&E[0])return{label:E[0]["@value"],uri:m}}else{const E=T["http://www.loc.gov/mads/rdf/v1#authoritativeLabel"];if(E&&E[0])return{label:E[0]["@value"],uri:m}}}}catch(f){console.error(`Error fetching subject ${I}:`,f)}return{label:I,uri:m}}return null}),C=await Promise.all(D);e.subjects=C.filter(b=>b!==null)}if(k){const v=k["http://id.loc.gov/ontologies/bibframe/publicationStatement"];v&&(e.publicationStatement=v[0]["@value"]);const y=k["http://id.loc.gov/ontologies/bibframe/extent"];if(y&&y[0]){const S=y[0]["@id"],g=n.find(x=>x["@id"]===S);if(g){const x=g["http://www.w3.org/2000/01/rdf-schema#label"];x&&(e.extent=x[0]["@value"])}}(k["http://id.loc.gov/ontologies/bibframe/identifiedBy"]||[]).forEach(S=>{const g=n.find(x=>x["@id"]===S["@id"]);if(g&&g["@type"]&&g["@type"].includes("http://id.loc.gov/ontologies/bibframe/Isbn")){const x=g["http://www.w3.org/1999/02/22-rdf-syntax-ns#value"];x&&e.isbn.push(x[0]["@value"])}})}return e}function wt(c){let n='<div class="content">';return c.title&&(n+=`<h4 class="title is-5">${c.title}</h4>`),c.contributors.length>0&&(n+='<div class="mb-3">',n+='<p class="mb-2"><strong>Contributors:</strong></p>',n+="<ul>",c.contributors.forEach(i=>{i.uri?n+=`<li><a href="${i.uri}" target="_blank">${i.name}</a></li>`:n+=`<li>${i.name}</li>`}),n+="</ul>",n+="</div>"),c.publicationStatement&&(n+=`<p><strong>Publication:</strong> ${c.publicationStatement}</p>`),c.extent&&(n+=`<p><strong>Extent:</strong> ${c.extent}</p>`),c.isbn.length>0&&(n+=`<p><strong>ISBN:</strong> ${c.isbn.join(", ")}</p>`),c.language.length>0&&(n+=`<p><strong>Language:</strong> ${c.language.join(", ")}</p>`),c.subjects.length>0&&(n+='<div class="mb-3">',n+='<p class="mb-2"><strong>Subjects:</strong></p>',n+="<ul>",c.subjects.slice(0,7).forEach(i=>{i.uri?n+=`<li><a href="${i.uri}" target="_blank">${i.label}</a></li>`:n+=`<li>${i.label}</li>`}),n+="</ul>",n+="</div>"),n+="</div>",n}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('form[action="/marva/quartz"], form[action*="marva"]').forEach(i=>{console.log("Found form with action:",i.action),i.addEventListener("submit",t=>{t.preventDefault();const e=new FormData(i),a=new URLSearchParams(e),v=(i.action.startsWith("http")?i.action:window.location.origin+i.action)+"?"+a.toString();console.log("Form submission intercepted, opening:",v),window.open(v,"_blank")})});const n=document.getElementById("search");if(n){const i=pt(t=>{performSearches(t.target.value)},500);n.addEventListener("input",i)}document.addEventListener("click",i=>{const t=i.target.closest(".collapsed-work-result");if(t){const k=t.dataset.allUris,v=t.dataset.title;k&&v&&handleCollapsedWorkClick(k,v);return}const e=i.target.closest(".title-result");if(e){const k=e.dataset.uri;if((e.classList.contains("single-instance")||e.classList.contains("instance-selection"))&&k.includes("/works/")){const v=k.replace("/works/","/instances/");Y(v)}else if(k.includes("/instances/"))Y(k);else{const v=e.querySelector(".has-text-weight-semibold"),y=v?v.textContent:"";vt(k,y)}}const a=i.target.closest(".contributor-box");if(a){const k=a.dataset.token,v=a.dataset.label;k&&k.startsWith("n")&&(document.querySelectorAll(".contributor-box").forEach(y=>{y.dataset.selected="false"}),a.dataset.selected="true",Q(k,v))}})});
